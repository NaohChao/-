/*　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　
　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　
　　　　　　　　　　　　　　　　　ＯＯＯＯＯＯ　　　　　　　　　　　　　　　　ＯＯＯ　　　　　ＯＯＯ　　　　　　　　　　
　　　　ＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯ　　　　　　　　　　　　　　　ＯＯＯ　　　　　ＯＯＯ　　　　　　　　　　
　　　　ＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯ　　　　　　　　　　　　　　　ＯＯＯ　　　　　ＯＯ　　　　　　　　　　　
　　　　ＯＯＯＯＯＯＯＯＯＯＯ　　　ＯＯ　　　　　　　　　　　　ＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯ　　　　
　　　　　　　ＯＯＯ　　　ＯＯ　　　ＯＯＯ　　　　　　　　　　　ＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯ　　　　
　　　　　　　ＯＯＯ　　　ＯＯ　　　ＯＯＯ　　　　　　　　　　　ＯＯＯＯ　　　　ＯＯ　　　　　ＯＯ　　　　ＯＯＯ　　　　
　　ＯＯＯ　　　ＯＯＯ　　ＯＯ　　ＯＯＯ　　　ＯＯＯ　　　　　　　　　　　　　ＯＯＯ　　　　　ＯＯＯ　　　　　　　　　　
　　ＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯ　　　　　　　　　　ＯＯＯＯＯ　　　　　ＯＯＯ　　　　　　　　　　
　　ＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯ　　　　　　　　　　ＯＯＯ　　　　　　　　　　　　　　　　　　　　
　　　　　　　　　ＯＯＯ　ＯＯＯＯＯＯ　　　　　　　　　　　　　　　　　　ＯＯＯ　　　　　　　　　　　　　　　　　　　　
　　　　　　　ＯＯＯＯＯ　ＯＯ　ＯＯＯＯ　　　　　　　　　　　　ＯＯＯＯ　ＯＯＯ　　　　　　　ＯＯＯＯＯＯＯＯＯ　　　　
　　　　　　ＯＯＯＯＯ　　ＯＯ　　ＯＯＯＯＯ　　　　　　　　　　ＯＯＯＯＯＯＯＯＯＯＯＯＯ　　ＯＯＯＯＯＯＯＯＯ　　　　
　　　ＯＯＯＯＯＯＯ　　　ＯＯ　　　ＯＯＯＯＯＯＯＯＯ　　　　　ＯＯＯＯＯＯＯＯＯＯＯＯＯ　　ＯＯ　　　　ＯＯ　　　　　
　ＯＯＯＯＯＯＯ　　　　　ＯＯ　　　　　ＯＯＯＯＯＯＯ　　　　　　　　　ＯＯＯ　　　ＯＯＯ　　ＯＯ　　　　ＯＯ　　　　　
　ＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯ　　　　　　　　　　ＯＯＯ　　　ＯＯＯ　　ＯＯ　　　　ＯＯ　　　　　
　　ＯＯＯ　ＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯ　ＯＯ　　　　　　　　　　ＯＯＯ　　　ＯＯＯ　　ＯＯ　　　　ＯＯ　　　　　
　　　　　　ＯＯ　　　　　ＯＯ　　　　　ＯＯＯ　　　　　　　　　　　　　ＯＯＯ　　　ＯＯＯ　　ＯＯ　　　　ＯＯ　　　　　
　　　　　　ＯＯ　　　　　ＯＯ　　　　　ＯＯ　　　　　　　　　　　　　ＯＯＯＯ　　　ＯＯＯ　　ＯＯ　　　　ＯＯ　　　　　
　　　　　　ＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯ　　　　　　　　　　　　　ＯＯＯ　　　　ＯＯＯ　　ＯＯ　　　　ＯＯ　　　　　
　　　　　　ＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯ　　　　　　　　　　　　ＯＯＯＯ　　　　ＯＯ　　　ＯＯ　　　　ＯＯ　　　　　
　　　　　　ＯＯ　　　　　ＯＯ　　　　　ＯＯ　　　　　　　　　　　　ＯＯＯＯ　　　　ＯＯ　　　ＯＯＯＯＯＯＯＯ　　　　　
　　　　　　ＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯ　　　　　　　　　　ＯＯＯＯ　ＯＯＯＯＯＯ　　　ＯＯＯＯＯＯＯＯ　　　　　
　　　　　　ＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯＯ　　　　　　　　　ＯＯＯＯ　　ＯＯＯＯＯＯ　　　ＯＯ　　　　ＯＯＯ　　　　
　　　　　　ＯＯ　　　　　　　　　　　　ＯＯＯ　　　　　　　　　ＯＯＯＯ　　　ＯＯＯＯＯ　　　ＯＯ　　　　ＯＯＯ　　　　
　　　　　　ＯＯ　　　　　　　　　　　　ＯＯＯ　　　　　　　　　　ＯＯ　　　　　　　　　　　　　　　　　　　　　　　　　
　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　
*/
#include "camera.h"
#include "common.h"
#include "include.h"

/***************前后车变量声明**************/
uint8 former_flag=1;

float steer_zhi_kp = 1; // 1;
float steer_zhi_kd = 3; //   3
float steer_xiaos_kp = 0.5;
float steer_xiaos_kd = 0.6;
float steer_wan_kp_left = 0.8;  // 0.8
float steer_wan_kd_left = 2;    //    2
float steer_wan_kp_right = 0.8; //   0.8
float steer_wan_kd_right =2;   //  2              //1.5;
float steer_enter_huandao_kp=0.8;
float steer_enter_huandao_kd=2;
float steer_exit_huandao_kp=0.8;
float steer_exit_huandao_kd=2;
float steer_mid_huandao_kp=1.8;
float steer_mid_huandao_kd=2;
float chasu_rate=0.26;    //0.3

extern int16 speed_right,speed_left,speed_set,speed_set_temp,speed_set_to_left,speed_set_to_right,speed,second_slow_speed,first_slow_speed;


extern int init_distance;
extern bool send_img_on;

extern int error_distance[4];
extern uint16 avg_distance;
extern int16 rightline[40];

uint8 imgbuff[CAMERA_R_H][CAMERA_W]; //定义存储接收图像的数组
uint8 imgpro[CAMERA_R_H][CAMERA_W];  //二值化处理图像数组
uint8 V_Cnt = 0;
uint8 img_flag = 1; //图像状态
// volatile IMG_STATUS_e      img_flag = IMG_START;        //图像状态

uint16 VS = 0;
uint16 HS = 0;
uint8 num;
int16 mid_old = 100;
int16 midline[40] = {0};
uint16 steer_out;
int i, j;
int count;
uint8 break_right, break_left;
int16 leftline[40];
//int16 rightline[40];
uint8 leftline_flag, rightline_flag;
uint8 xiaos_flag, shizi_flag, dawan_flag;
uint8 shizi_flag_zhi;
uint8 start_find;
unsigned char find_line_right, find_line_left = 0;
unsigned char sao_zuo, sao_you = 1;
unsigned char shizi_flag, shizi_flag_zhi = 0;
unsigned char white = 0;
unsigned char start_find, allwhite = 0;
float slope1, slope2, slope;
unsigned char xierushizi_flag = 0;
unsigned char tiaobian = 0;
unsigned char shizi_flag_xie = 0;
unsigned char shizi_star = 0;
unsigned char find = 0;
unsigned char break_left_shizi, break_right_shizi = 0;
uint8 shizi_star_right, shizi_star_left;
uint8 xiaos_flag = 0;
int zhongxian_front[4] = {0};
int zhongxian_back[4] = {0};
uint8 zhidao_flag, wandao_flag = 0;
int error_steer[6] = {0};
uint8 count_ruwan, count_chuwan = 0;
uint8 ruwan_flag, chuwan_flag = 0;
int zhongxian_front_ave, zhongxian_back_ave = 0;
int tubian = 0;

long time_now = 0;
uint8 weight[20] = {20, 19, 18, 17, 16, 15, 14, 13, 12, 11,
10, 9, 8, 7, 6, 5, 4, 3, 2, 1};
uint8 width[40] = {
  41,42,43,44,45,46,48,51,53,56,59,61,64,69,71,75,78,82,86,90,
  93,97,99,103,107,111,113,116,119,121,124,127,130,133,136,139,140,143,145,148};
uint8 kuandu[40];

int panduan_flag = 0;
float slope_xierushizi;
int time;
/***************环岛判断变量声明**************/
int tiaobian_left=0;   
int tiaobian_right=0;
uint8 ruhuandao_flag=0;
uint8 chuhuandao_flag=1;
uint8  white_flag=0; 
int up_dot_zuo=0;
int up_dot_you=0;
uint8 huandao_up_dot_zuo=0;
uint8 huandao_up_dot_you=0;
int  tiaobian_middle=0;
int huandao_tiaobian=0;
int16 up_dot_line[11];
int count_black1,count_black2;   //1代表左边，2代表右边
int edge_length1,edge_length2;
int kuandu_cha1,kuandu_cha2;
int16 up_lie[11];
int huandao_width1,huandao_width2;
int chuhuan_lie,chuhuan_hang;
int up_lie_right,up_lie_left;
int distance1,distance3;      //入环岛测量距离，出环岛测量距离
int huan_buxian_lie,huan_buxian_hang;
float slope_huan,slope_chuhuan,slope_chuhuan1;
float  slope_tiaobian_chu1,slope_tiaobian_chu2;
int count_white,huandao_diu_count;
int huandao_find_right,huandao_find_left;
int huandao_count=1;
extern int huandao_set[8],huandao_chaoche_set[8],huandao_size_set[8];   //0右边，1左边
int huandao[8];
int huandao_number=7;
bool qian_shizi_flag; //防止后车在十字误判环岛变量
int huandao_houche=0;
int Distance;
bool ruhuandao_ready,ruhuandao_may;
float slope_chuhuan_zuo,slope_chuhuan_you,slope_ruhuan_zuo,slope_ruhuan_you;
int chuhuan_diu_count,chuhuan_find_left,chuhuan_find_right,ruhuan_diu_count,ruhuan_find_left,ruhuan_find_right;
int zuoruhuan_diu_count,zuoruhuan_diu_find,youruhuan_diu_count,youruhuan_diu_find;
float slope_ruhuan_diu_zuo,slope_ruhuan_diu_you;
float slope_you_shizi,slope_huanzuo_judge,slope_huanyou_judge;
int16 huan_rightline[40],huan_leftline[40];
long huan_temp;
int huan_zhongxian_front;
int shizi_judge_mid;
int huan_judge_bottom1,huan_judge_bottom2,huan_judge_top1,huan_judge_top2;
int right_jump,left_jump,jump_width;
uint8 huandao_size,change_num;
float slope_zuo_judge,slope_you_judge;
bool huan_you_flag,first_diu_you_flag,huan_zuo_flag,first_diu_zuo_flag;
int ruhuan_break_right,ruhuan_break_left;
float slope_huanyou_old,slope_huanzuo_old;
int zuo_ruhuan_start,you_ruhuan_start;
bool chuhuandao_ceju_flag=0;
/***************障碍变量声明**************/
int16 zhangai_line_zuo[CAMERA_R_H],zhangai_line_you[CAMERA_R_H],zhangai_line_you1[CAMERA_R_H];
int16 zhangai_start, zhangai_break,zhangai_start_zuo,zhangai_start_you;
uint8 zhangaifind_flag,zhangaifind_you_flag,zhangaifind_zuo_flag;
int zhangai_max, zhangai_min, zhangai_middle;
uint8 zhangai_left_flag, zhangai_right_flag, zhangai_flag;
int OA_replace_flag = 0, OB_replace_flag = 0;
int OA_distance = 0;
uint16 zhangai_lilun_middle;
int8 zhangai_back_flag;
int64 OA_distance2 = 0, OB_distance = 0;
int zhangai_count;
float b_right,b_left;
float slope_shizi_left, slope_shizi_right,slope_zhangai_qian;
int zhangai_final;
float slope_zhangai_you,slope_zhangai_zuo;
float za_slope;
int bizhang_flag; 
/***************超车变量声明**************/
extern bool cruise_mode_on;
int16 chaoche_line_zuo[CAMERA_R_H],chaoche_line_you[CAMERA_R_H];
int16 chaoche_start_zuo,chaoche_start_you,chaoche_start,chaoche_break;
uint8 chaoche_left_flag, chaoche_right_flag,chaoche_flag,chaochefind_flag,chaochefind_zuo_flag;
bool jieshouchaoche_flag;
int zhidao_chaoche_count=1;
extern int zhidao_chaoche_num;
uint8 chaoche_ready_flag;
float cc_slope;
int chaoche_distance;
uint8 send_num;
uint8 send_show_number;
int chaoche_distance;
int safe_distance,front_distance;
uint8 turn_flag,Left_turn_flag,tingche_chaoche_flag;
int dajiao_distance,chaoche_stop_distance,shizi_hui_distance;
int midline_drift;
int hui_flag;
bool chaochesudu_flag;
int zhubei_chaoche_flag,shizi_hui_flag;
bool shizi_chaoche_flag,shizi_ready_flag,shizi_tingche_flag;
int shizi_chaoche_distance,zhongxian_stop,shizi_front_distance;
/***************通讯**************/
uint8 relen;
uint8 buff[DATA_PACKET];
uint8 start_flag=0;
int send_count;
int receive_count;
/***************十字声明**************/
int shizi_count=0;
int shizi_distance=0;
uint8 bizhang_zhidao_flag;
int shizi_tiaobian,shizi_kuandu;
int qinxie_zhi,xrshizi_diu_count,xrshizi_find_right;
float slope_xrszdiu,slope_shizi_judge,slope_zuo_shizi;
uint8 shizi_buxian_flag,shizizhi_judge;
float slpoe_xieshizi_left,slpoe_xieshizi_right;
int shizi_start_left,shizi_start_right;
//调试
int start_refind,shizi_restart,shizi_start_mid;
int xieshizi_tiaobian,xieshizi_jump_width;
int xieshizi_zuodiu_count,xieshizi_youdiu_count,xieshizi_find_left,xieshizi_find_right,xieshizi_break_right,xieshizi_break_left,xieshizi_rebreak_left,xieshizi_you_restart,xieshizi_rebreak_right;
float slpoe_xieshizi_leftback,slpoe_xieshizi_leftfront,slpoe_xieshizi_rightback,slpoe_xieshizi_rightfront;
int xieshizi_left_tiaobian,xieshizi_right_tiaobian,zhishizi_left_tiaobian,zhishizi_right_tiaobian;
float slope_xieshizi_you,slope_xieshizi_zuo;
/***************赛道判断声明**************/
float slope_front_left,slope_front_right,slope_back_left,slope_back_right;
float cha_xlv_front,cha_xlv_back,break_start;
int avg_front = 0,curve=0,avg_front_shiji=0;
int valid_line,fangcha,fangcha_cha,fangcha_old=0;
int16 left_cha[40],right_cha[40],mid_cha[40];
int chaoche_zhidao_flag;
int zhangai_distance=0;
int  allwhite1=0;
int kuandu_sum,kuandu_avg;  //识别坡道  赛道宽度
bool zhenzhidao_flag,podao_zhidao_flag;
int aobian_left,aobian_right;

/***************起跑线声明**************/
int tubian_count=0;
bool qipaoxian_flag=0,stop_flag=0,qipaoxian_flag_fa;
int stop_distance=0;
bool zhongdianjiasu_flag=0;
extern int speedset_st;
uint8 steer_qian=0;
bool keep_front_steer_flag;
int zhongdianzhangai_location=0;   //0没有障碍  1左  2右
/***************发车变量声明**************/
extern int fache_flag; //0为正常发车 1为起跑超车发车
int fache_distance;
bool fache_finish_flag=1;
int fache_state=0;   //发车过程中的状态变化标志，是中转量  
/***************出赛道变量声明**************/
bool chusaidao_flag;
int black;
/***************坡道变量声明**************/
int podao_distance;
bool podao_ready_flag;
int podao_count;
bool podao_flag=0;
/***************偏差变量声明**************/
int error_piancha;
int error_I=0;
extern float DIRC_D,DIRC_P,DIRC_I;
/***************判断车辆丢失变量声明**************/
int diushi_count=0,diushi_time=0;
int qipaoxian_count=0;
/*********************************************
！！最小二乘法公式！！
*********************************************/
int SumX = 0;
int SumY = 0;
long x_2 = 0;
long x_y = 0;
float AverageX;
float AverageY;
float AverageX_2;
float AverageX_Y;
int xielv_cal;
int AvaliableLines;

int Least_Squares(int16 *array, int16 Number, int16 start)
{
  AvaliableLines = Number;
  SumX = 0;
  SumY = 0;
  x_2 = 0;
  x_y = 0;
  
  for (i = start; i >= start - Number + 1; i--) //数组溢出
  {
    SumX = SumX + i;
    SumY = SumY + (*(array + i));
    x_2 = x_2 + i * i;
    x_y = x_y + i * (*(array + i));
  }
  
  AverageX = (float)SumX / AvaliableLines;
  AverageY = (float)SumY / AvaliableLines;
  AverageX_2 = (float)x_2 / AvaliableLines;
  AverageX_Y = (float)x_y / AvaliableLines;
  
  xielv_cal = (AverageX_Y - AverageX * AverageY) * 10 /
    (AverageX_2 - AverageX * AverageX);
  
  return xielv_cal;
}
/*********************************************
比较大小
*********************************************/
int max(int a, int b, int c, int d)
{
  int t[4] = {a, b, c, d};
  int max = t[0];
  int i;
  for (i = 0; i < 4; i++)
  {
    if (max < t[i])
      max = t[i];
  }
  return max;
}
int min(int a, int b, int c, int d)
{
  int t[4] = {a, b, c, d};
  int min = t[0];
  int i;
  for (i = 0; i < 4; i++)
  {
    if (min > t[i])
      min = t[i];
  }
  return min;
}

uint8 sz[CAMERA_R_H] = {
  30, 31, 32, 34, 36, 38, 41, 44, 47, 51, 55, 59, 64,
  69, 74, 80, 86, 92, 98, 104, 110, 116, 122, 128, 134, 140,
  146, 152, 158, 164, 170, 176, 182, 188, 194, 200, 206, 212, 218,
  224 //,230
};

void camera(void)
{
  //   if(speedset_st==75)
  //  {
  //    steer_zhi_kp = 0.5; // 1;
  //    steer_zhi_kd = 0.7; //   3
  //    steer_xiaos_kp = 0.3;
  //    steer_xiaos_kd = 0.2;
  //    steer_wan_kp_left = 0.9; 
  //    steer_wan_kd_left = 2.3;
  //    steer_wan_kp_right = 0.9; 
  //    steer_wan_kd_right =2.3; 
  //    
  //    steer_enter_huandao_kp=0.8;
  //    steer_enter_huandao_kd=2.2;
  //    
  //    steer_mid_huandao_kp=1.8;
  //    steer_mid_huandao_kd=2.6;//2.8
  //    
  //    steer_exit_huandao_kp=1.0;
  //    steer_exit_huandao_kd=0.3;
  //
  //    chasu_rate=0.3;
  //  }
  //  if(speedset_st==80)
  //  {
  //    steer_zhi_kp = 0.5; // 1;
  //    steer_zhi_kd = 0.7; //   3
  //    steer_xiaos_kp = 0.3;
  //    steer_xiaos_kd = 0.1;
  //    steer_wan_kp_left = 0.8;  // 0.8
  //    steer_wan_kd_left = 2.1;    //    2
  //    steer_wan_kp_right = 0.8; //   0.8
  //    steer_wan_kd_right =2.1;   //  2              //1.5;
  //
  //    steer_enter_huandao_kp=0.8;
  //    steer_enter_huandao_kd=2.2;
  //
  //    steer_mid_huandao_kp=1.8;
  //    steer_mid_huandao_kd=2.6;
  //    
  //    steer_exit_huandao_kp=1.0;
  //    steer_exit_huandao_kd=0.3;
  //    
  //    chasu_rate=0.3;
  //  }
  //  if(speedset_st==85)
  //  {
  //    steer_zhi_kp = 0.5; // 1;
  //    steer_zhi_kd = 0.7; //   3
  //    steer_xiaos_kp = 0.3;
  //    steer_xiaos_kd = 0.1;
  //    steer_wan_kp_left = 1.1;  // 0.8
  //    steer_wan_kd_left = 2.5;    //    2
  //    steer_wan_kp_right = 1.1; //   0.8
  //    steer_wan_kd_right =2.5;   //  2              //1.5;
  //    
  //    steer_enter_huandao_kp=0.8;
  //    steer_enter_huandao_kd=2.1;
  //    
  //    steer_mid_huandao_kp=1.8;
  //    steer_mid_huandao_kd=2.6;
  //
  //    steer_exit_huandao_kp=1.5;
  //    steer_exit_huandao_kd=0.4;
  //    chasu_rate=0.3;
  //  }
  //    if(speedset_st==90)
  //  {
  //    steer_zhi_kp = 0.5; // 1;
  //    steer_zhi_kd = 0.7; //   3
  //    steer_xiaos_kp = 0.3;
  //    steer_xiaos_kd = 0.1;
  //    steer_wan_kp_left = 0.9;  // 0.8
  //    steer_wan_kd_left = 2.1;    //    2
  //    steer_wan_kp_right = 0.9; //   0.8
  //    steer_wan_kd_right =2.1;   //  2              //1.5;
  //    
  //    steer_enter_huandao_kp=0.8;
  //    steer_enter_huandao_kd=2.1;
  //    
  //    steer_mid_huandao_kp=1.8;
  //    steer_mid_huandao_kd=2.1;
  //
  //    steer_exit_huandao_kp=1.0;
  //    steer_exit_huandao_kd=0.3;
  //    chasu_rate=0.3;
  //  }
  
  
  
  
  if (img_flag == 3)
  {
    img_flag = 4;
    
    PORTC_ISFR = ~0; //写1清中断标志位(必须的，不然回导致一开中断就马上触发中断)
    enable_irq(PORTC_IRQn);
    img_flag = 1;
    
    
      nrf_process();
    LP_image();
    
    /*************各种标志清零********************/
    
    sao_zuo = 1;
    sao_you = 1;
    leftline_flag = 0;
    rightline_flag = 0;
    break_right = 39;
    break_left = 39;    
    /**************环岛方向切换*******************/
    if(cruise_mode_on==0)
    {
      if(chuhuandao_flag==1)
      {
        switch (former_flag)//切换后车环岛方向
        {
        case 1:
          huandao[huandao_count] = huandao_set[huandao_count];
          break;
        case 0:
          huandao[huandao_count] = !huandao_set[huandao_count];
          break;
        }
      }
    }
    else 
    {
      switch (former_flag)//切换后车环岛方向
      {
      case 1:
        huandao[huandao_count] = huandao_set[huandao_count];
        break;
      case 0:
        huandao[huandao_count] = huandao_set[huandao_count];
        break;
      }
    }
    
    /*************确定基础寻线开始的点***************/
    if (mid_old <= 1 + Interval)
    {
      sao_zuo = 0;
      mid_old = 1 + Interval;
    }
    else if (mid_old >= CAMERA_W - Interval - 2)
    {
      sao_you = 0;
      mid_old = CAMERA_W - Interval - 2;
    }
    
    /*************开始扫描最底行左线*******************/
    if (sao_zuo == 1 && qipaoxian_flag == 0 && fache_finish_flag == 1)
    {
      for (i = mid_old; i >= Interval + 1; i--)
      {
        if (imgbuff[Last_line][i] - imgbuff[Last_line][i - Interval] > Jump_threhold && imgbuff[Last_line][i] - imgbuff[Last_line][i - Interval - 1] > Jump_threhold) //  多加了一个扫描点
        {
          leftline[Last_line] = i - Interval;
          leftline_flag = 1;
          break;
        }
        else
        {
          leftline_flag = 0;
        }
      }
    }
    /*************开始扫描最底行右线*******************/
    if (sao_you == 1&&qipaoxian_flag==0&&fache_finish_flag==1)
    {
      for (i = mid_old; i <= CAMERA_W - Interval - 2; i++)
      {
	if (imgbuff[Last_line][i] - imgbuff[Last_line][i + Interval] > Jump_threhold&&imgbuff[Last_line][i] - imgbuff[Last_line][i + Interval+1] > Jump_threhold) //  多加了一个扫描点
	{
	  rightline[Last_line] = i + Interval;
	  rightline_flag = 1;
	  break;
	}
	else
	{
	  rightline_flag = 0;
	}
      }
    }
    /*************起跑线扫描最底行左线*******************/
    if (sao_zuo == 1&&(qipaoxian_flag==1||fache_finish_flag==0))
    {
      for (i =0 ; i <= mid_old- Interval -2 ; i++)
      {
	if (imgbuff[Last_line][i + Interval]-imgbuff[Last_line][i] >Jump_threhold &&imgbuff[Last_line][i + Interval+1]-imgbuff[Last_line][i+1] >Jump_threhold &&imgbuff[Last_line][i + Interval+2]-imgbuff[Last_line][i+2] >Jump_threhold)//  多加了一个扫描点
	{
	  leftline[Last_line] = i + Interval;
	  leftline_flag = 1;
	  break;
	}
	else
	{
	  leftline_flag = 0;
	}
      }
    }
    /*************起跑线扫描最底行右线*******************/
    if (sao_you == 1&&(qipaoxian_flag==1||fache_finish_flag==0))
    {
      for (i = CAMERA_W-1 ; i >= mid_old + Interval + 2; i--)
      {
	if (imgbuff[Last_line][i - Interval]-imgbuff[Last_line][i] >Jump_threhold && imgbuff[Last_line][i - Interval-1]-imgbuff[Last_line][i-1] >Jump_threhold &&imgbuff[Last_line][i - Interval-2]-imgbuff[Last_line][i-2] >Jump_threhold)//  多加了一个扫描点
	{
	  rightline[Last_line] = i - Interval;
	  rightline_flag = 1;
	  break;
	}
	else
	{
	  rightline_flag = 0;
	}
      }
    } 
    /*************最底行补线程序*****************/
    if (leftline_flag == 1 && rightline_flag == 0)
    {
      rightline[Last_line] = leftline[Last_line] + 148;
      if (rightline[Last_line] < CAMERA_W)
      {
        rightline[Last_line] = CAMERA_W;
      }
    }
    
    if (leftline_flag == 0 && rightline_flag == 1)
    {
      leftline[Last_line] = rightline[Last_line] - 148;
      if (leftline[Last_line] > 0)
      {
        leftline[Last_line] = 0;
      }
    }
    
    midline[Last_line] = (rightline[Last_line] + leftline[Last_line]) / 2;
    mid_old = midline[Last_line];
    
    /***************基本跟踪算法*********************/     
    //左线跟踪
    if (leftline_flag == 1&&qipaoxian_flag==0&&fache_finish_flag==1) /////
    {
      for (int i = CAMERA_R_H - 2; i >= 0; i--) // 40
      {
	for (j = Tracking_NUM; j >= 0; j--) ///    18
	{
	  if (leftline[i + 1] + j - Interval - Tracking_displacement >= 0 &&leftline[i + 1] + j - Tracking_displacement <CAMERA_W) //   9
	  {
	    if (imgbuff[i][leftline[i + 1] + j -Tracking_displacement] -imgbuff[i][leftline[i + 1] + j - Interval - Tracking_displacement] > (Jump_threhold - 0.3 * (39 - i))) //  0.3
	    {
	      leftline[i] = leftline[i + 1] + j - Interval - Tracking_displacement;
	      find_line_left = 1;
	      break_left = 0;
	      break;
	    }
	    else
	    {
	      find_line_left = 0;
	    }
	  }
	}
	if (find_line_left == 0)
	{
	  break_left = i+1;
	  break;
	}
      }
    }
    
    //右线跟踪
    if (rightline_flag == 1&&qipaoxian_flag==0&&fache_finish_flag==1) 
    {
      for (int i = CAMERA_R_H - 2; i >= 0; i--)
      {	
	for (j = 0; j <= Tracking_NUM; j++) //  18
	{
	  if (rightline[i + 1] + j - Tracking_displacement >= 0 &&rightline[i + 1] + j - Tracking_displacement + Interval < CAMERA_W)
	  {
	    if (imgbuff[i][rightline[i + 1] + j - Tracking_displacement] -imgbuff[i][rightline[i + 1] + j - Tracking_displacement + Interval] >(Jump_threhold - 0.3 * (39 - i)))       // gai imgbuff[i][rightline[i + 1] + j - Tracking_displacement -Interval] -imgbuff[i][rightline[i + 1] + j - Tracking_displacement] >(Jump_threhold - 0.3 * (39 - i))
	    {
	      rightline[i] = rightline[i + 1] + j - Tracking_displacement + Interval;
	      find_line_right = 1;
	      break_right = 0;
	      break;
	    }
	    else
	    {
	      find_line_right = 0;
	    }
	  }
	}
	if (find_line_right == 0)
	{
	  break_right = i+1;
	  break;
	}
      }
    }
    //左线起跑线跟踪
    if (leftline_flag == 1&&(qipaoxian_flag==1||fache_finish_flag==0)) /////
    {
      for (int i = CAMERA_R_H - 2; i >= 0; i--) // 40
      {
	for (j = 0; j <= Tracking_NUM; j++) ///    18
	{
	  if (leftline[i + 1] + j + Interval - Tracking_displacement < CAMERA_W &&leftline[i + 1] + j - Tracking_displacement >= 0) //   9
	  {
	    if (imgbuff[i][leftline[i + 1] + j + Interval - Tracking_displacement] -imgbuff[i][leftline[i + 1] + j - Tracking_displacement] >(Jump_threhold - 0.3 * (39 - i))) //  0.3
	    {
	      leftline[i] = leftline[i + 1] + j + Interval - Tracking_displacement;
	      find_line_left = 1;
	      break_left = 0;
	      break;
	    }
	    else 
	    {
	      find_line_left = 0;
	    }
	  }
	}
	if (find_line_left == 0)
        {
	  break_left = i + 1;
	  break;
	}
      }
    }
    
    //右线起跑线跟踪
    if (rightline_flag == 1 && (qipaoxian_flag == 1 || fache_finish_flag == 0))
    {
      for (int i = CAMERA_R_H - 2; i >= 0; i--)
      {
        for (j = Tracking_NUM; j >= 0; j--) //  18
        {
          if (rightline[i + 1] + j - Interval - Tracking_displacement >= 0 && rightline[i + 1] + j - Tracking_displacement < CAMERA_W)
          {
            if (imgbuff[i][rightline[i + 1] + j - Interval - Tracking_displacement] - imgbuff[i][rightline[i + 1] + j - Tracking_displacement] > Jump_threhold - 0.3 * (39 - i))
            {
              rightline[i] = rightline[i + 1] + j - Interval - Tracking_displacement;
              find_line_right = 1;
              break_right = 0;
              break;
            }
            else
            {
              find_line_right = 0;
            }
          }
        }
        if (find_line_right == 0)
        {
          break_right = i + 1;
          break;
        }
      }
    }
    /*************发车准备********************/
    //    if(cruise_mode_on == 1)
    //    {
    //      fache_finish_flag=1;
    //    }
    if(fache_finish_flag==0)                 //正常和超车发车模式都要测距
    {
      fache_distance=(speed_left+speed_right)/2+fache_distance;
    }
    if(fache_flag==0&&fache_finish_flag==0)     //正常发车模式
    {
      if(former_flag==1) 
      {
        speed=speedset_st;
        
	if(fache_distance>1300)
	{
	  fache_finish_flag=1;
	  fache_distance=0;
	}
      }                //前车发车
      if(former_flag==0)
      {
	if(avg_distance>=600&&avg_distance<=3000)
	{
	  speed=speedset_st;
	}
	else
	{
	  speed=0;
	}
	if(fache_distance>1800)
	{
	  fache_finish_flag=1;
	  fache_distance=0;
	}       
      }
      zhongxian_front[0]=midline[Last_line];
    }
    
    if(fache_flag==1&&fache_finish_flag==0&&former_flag==0)     //超车发车模式  仅针对番茄作为后车  
    {          
      long temp;
      temp = 0;
      for (i = CAMERA_R_H - 2; i >= 19; i--)      
      {
        temp = temp + weight[i - 19] * rightline[i];
      }
      zhongxian_front[0] = (temp / 210)-20;//30
      if (fache_state==0)
      {      
        speed=0;
      }  
      if(fache_state==1)//收到起步信号
      {
        if(avg_distance>=600&&avg_distance<2500)
        {
          speed=speedset_st;  
          fache_state=2;
        }
        else
        {      
          speed=0;
        }        
      }  
      if(fache_distance>4000)
      {
        fache_distance=0;
        fache_state=3;
      } 
      if(fache_state==3&&former_flag==0)
      { 
        if(leftline_flag==0)
        {
          for (i = CAMERA_R_H - 1; i >= 19; i--)   
          {
            leftline[i]=rightline[i]-width[i]; 
          }
          speed=speedset_st;
        }
        else
        {
          fache_finish_flag=1;
          speed=speedset_st;
        }
      }
      if(fache_finish_flag==1&&former_flag==0)
      {
        send_num=5;
        former_flag=1;
      }
    }     

    if(fache_finish_flag==0)
    {
      error_steer[1]=error_steer[0];
      error_steer[0]=100 - zhongxian_front[0];   
      steer_out = steer_mid + steer_zhi_kp * error_steer[0]+0.5 * (error_steer[0] - error_steer[1]); 
    }

    if(fache_finish_flag==1)
    {      
      /******************************************************
      处理起跑线
      ******************************************************/
      tubian_count=0;
      if(bizhang_zhidao_flag==1&&former_flag==1&&qipaoxian_flag==0)    //前车识别起跑线停车 
      {
	for (int i = 17; i >= 15; i--)
	{
	  for(j = zhongxian_front[0]-width[i]/2; j <= zhongxian_front[0]+width[i]/2; j++)// zhongxian_front[0]
	  {
	    if((imgbuff[i][j] - imgbuff[i][j+3] > Jump_threhold) && (imgbuff[i][j]-imgbuff[i][j+4]>Jump_threhold )&&imgbuff[i][j]>150&&imgbuff[i][j+3]<150)//白到黑
	    {
	      tubian_count++;
	    }
            if(tubian_count>18)
            {
              qipaoxian_flag=1;
              break;
            } 
	  }
	  if(qipaoxian_flag==1)
	  {
	    break;
	  } 
	  else
	  {
	    tubian_count=0;
	  }
	}
      }
      if(qipaoxian_flag==1&&former_flag==1)           //前车处理起跑线
      {
        if(stop_distance>3000)
          qipaoxian_flag=0;
        //speed=0;
//        if(zhongdianjiasu_flag==0)
//        {
//          speed=30;
//          send_num=6;                  //发给后车 qipaoxian_flag
//        }
//        else 
//        {
//          speed=speedset_st;
//        }       
//        if(zhongdianjiasu_flag==1&&stop_distance > 3600)
//        {
//          //stop_flag=0;
//          speed = 0;
//          speed_set = 0;
//        }
      }    
      if(qipaoxian_flag_fa==1&&former_flag==0)           //后车处理起跑线
      {

         if(avg_distance>450&&avg_distance<=550)
        {
          send_num=11;         //发送给前车重新加速  zhongdianjiasu_flag
          zhongdianjiasu_flag=1;
          stop_flag=1;//stop_flag=1时 后车不再检测障碍，(只有后车有stop_flag)
          qipaoxian_flag=1;
        }
         else if(stop_distance>=3500&&avg_distance<=250)
         {
           speed=0;
           speed_set=0;
         }
      }      
      if(qipaoxian_flag==1)
      {
	stop_distance=(speed_left+speed_right)/2+stop_distance; 
      }
      
      
      
   /******************************************************
      控距处理
   ******************************************************/
      if(qipaoxian_flag_fa==1&&former_flag==0)
      {
        Distance=250;
        //gpio_set(PTD8,0);
      }
      else 
      {
        Distance=1000;
        //gpio_set(PTD8,1);
      }  
      
      
      
      
      
      
      
      
      //****直入十字判断*****//
      shizi_flag_zhi = 0;
    //  shizi_count=0;
      if((break_left>=35||break_right>=35)&&abs(break_right-break_left)<=4&&ruhuandao_flag==0&&chuhuandao_flag==1) ////可能出现十字的情况，两边同时无法跟踪，且差的绝对值不大   //5  //加入入环岛标志位=0
      {
        if(break_left<=break_right) //确定开始搜索全白图像的起点
        {
          start_find = break_left;
        }
        else
        {
          start_find = break_right;
        }
        if(zhongxian_front[1]<0||zhongxian_front[1]>199)    //shizi_flag_zhi!=0
        {
          if(break_right!=39 && break_left!=39)
          {
            shizi_judge_mid=(rightline[CAMERA_R_H-1]+leftline[CAMERA_R_H-1])/2;
          }
          else if(break_right==39&&break_left!=39)
          {
            shizi_judge_mid=leftline[CAMERA_R_H-1]+100;
          }
          else if(break_left==39&&break_right!=39)
          {
            shizi_judge_mid=rightline[CAMERA_R_H-1]-100;
          }
          else
          {
            shizi_judge_mid=mid_old;
          }
        }
        else if(zhongxian_front[1]>=0&&zhongxian_front[1]<=199)     //shizi_flag_zhi!=0
        {        
          shizi_judge_mid=zhongxian_front[1];
        }
        count = 0;
        if(former_flag==1)
        {
          if(shizi_count==0)
          {
            if(shizi_judge_mid>=0&&shizi_judge_mid<=199)
            {
              for(i=39;i>=3;i--)   
              {
                if(imgbuff[i][shizi_judge_mid]-imgbuff[i-3][shizi_judge_mid]>Jump_threhold)
                {
                  shizi_tiaobian=i-3;      ////// //////!!!!!!!!!!!!!!!!!!!!!!
                  break;
                }
                else
                {
                  shizi_tiaobian=0;
                }
              }
            }
            else
            {
              shizi_tiaobian=0;
            }
          }
        }
        for(j=start_find-1;j>=start_find-4;j--)
        {
          allwhite=0;
          for(i=0;i<=CAMERA_W-1;i++)
          {
            if(imgbuff[j][i]>150) //直接对当前行进行检测，判断是否为全白
            {
              allwhite++;
            }
          }
          if(allwhite>=CAMERA_W-5) 
          {
            allwhite = 0;
            count++; //判断当白点数过多时，则认为前方为十字，开始从前往后补线
          }
          if(count>=2)
          {
            if(shizi_count==0)
            {
              if(former_flag==1)
              {
                shizi_kuandu=39-shizi_tiaobian;
                if(abs(shizi_kuandu)>25)
                {
                  shizi_flag_zhi = 1;
                  shizi_count=1;
                }
              }
              else if(former_flag==0)
              {
                shizi_flag_zhi = 1;       
                shizi_count=1;
              }
            }
            if(shizi_count==2)
            {
              shizi_count=3;
            }
            break;
          }
        }
      }
      
      if(shizi_count==1)
      {
        shizi_distance=(speed_left+speed_right)/2+shizi_distance;
        if(shizi_distance>=1200)
        {
          shizi_count=2;
          shizi_distance=0;
          qian_shizi_flag=0;  ///////清掉前十字标志位
        }
      }
      if(shizi_count==3)
      {
        shizi_distance=(speed_left+speed_right)/2+shizi_distance;
        if(shizi_distance>=1100)
        {
          shizi_count=0;
          shizi_distance=0;
          qian_shizi_flag=0;///////清掉前十字标志位
        }
      }
      
      /**************寻找十字重新开始行*************/  
      if((shizi_count==1||shizi_count==3)&&(zhongxian_front[1]<Interval+1||zhongxian_front[1]>CAMERA_W-Interval-2))    //    (shizi_count==1||shizi_count==3)
      {
        if(break_right!=39 && break_left!=39)
        {
          shizi_start_mid=(rightline[CAMERA_R_H-1]+leftline[CAMERA_R_H-1])/2;
        }
        else if(break_right==39&&break_left!=39)
        {
          shizi_start_mid=leftline[CAMERA_R_H-1]+100;
        }
        else if(break_left==39&&break_right!=39)
        {
          shizi_start_mid=rightline[CAMERA_R_H-1]-100;
        }
        else
        {
          shizi_start_mid=mid_old;
        }
      }
      else if((shizi_count==1||shizi_count==3)&&zhongxian_front[1]>=Interval+1&&zhongxian_front[1]<=CAMERA_W-Interval-2)     //    (shizi_count==1||shizi_count==3)
      {        
        shizi_start_mid=zhongxian_front[1];
      }
      
      /*********************直入十字补线程序**************************/  
      if((shizi_count==1||shizi_count==3)&&shizi_start_mid>=Interval+1&&shizi_start_mid<=CAMERA_W-Interval-2) //如果十字标志位等于一，那么就继续向前寻找可以跟踪的黑线     shizi_count==1||shizi_count==3
      {    
        shizi_star_left = 39;
        count = 0;
        for(i=start_find-3;i>=0;i--)
        {
          for(j=shizi_start_mid;j>=Interval+1;j--)
          {
            if(imgbuff[i][j]-imgbuff[i][j-Interval]>Jump_threhold&&imgbuff[i][j]>150&&imgbuff[i][j-Interval]<150&&imgbuff[i][j]-imgbuff[i][j-Interval-1]>Jump_threhold) /////////   跳变大小？？？？？？？？   /////////
            {
              count++;
              leftline[i]=j-Interval;        //leftline[i]=j-Interval;
              break;
            }
          }
          if(count==3)
          {
            count=0;
            shizi_star_left=i;
            break;
          }
        }
        
        shizi_star_right=39;
        count=0;
        for(i=start_find-3;i>=0;i--)
        {
          for(j=shizi_start_mid;j<=CAMERA_W-Interval-2;j++)
          {
            if(imgbuff[i][j]-imgbuff[i][j+Interval]>Jump_threhold&&imgbuff[i][j]>150&&imgbuff[i][j+Interval]<150&&imgbuff[i][j]-imgbuff[i][j+Interval+1]>Jump_threhold) /////////   跳变大小？？？？？？？？   /////////
            {
              count++;
              rightline[i]=j+Interval;
              break;
            }
          }
          if(count==3)
          {
            count=0;
            shizi_star_right=i;
            break;
          }
        }
        if(abs(shizi_star_right-shizi_star_left)<=7)
        {
          if(shizi_star_right<shizi_star_left) //当再次找到开始的黑线位置时，将开始位置靠前的赋值给实际开始位置
          {
            shizi_start_left=shizi_star_right;
            shizi_start_right=shizi_star_right;
          }
          else
          {
            shizi_start_right=shizi_star_left;
            shizi_start_left=shizi_star_left;
          }
        }
        else
        {
          if(shizi_star_right<shizi_star_left) //当再次找到开始的黑线位置时，将开始位置靠前的赋值给实际开始位置
          {
            shizi_start_left=shizi_star_left;
            shizi_start_right=0;
          }
          else
          {
            shizi_start_right=shizi_star_right;
            shizi_start_left=0;
          }
        }
        if(shizi_start_right!=0||shizi_start_left!=0)
        {         
          /**************重新开始的十字黑线跟踪程序*****************/
          if(shizi_start_left!=0)
          {
            for(j=shizi_start_mid;j>=Interval;j--) //开始寻找十字开始的基准点            /////////////!!!!!!!!!!!!!!
            {
              if(imgbuff[shizi_start_left][j]-imgbuff[shizi_start_left][j-Interval]>Jump_threhold&&imgbuff[shizi_start_left][j]>150&&imgbuff[shizi_start_left][j-Interval]<150)
              {
                leftline[shizi_start_left]=j-Interval;
                break;
              }
            }
            break_left_shizi = 39;            
            for(i=shizi_start_left-1;i>=0;i--)   // shizi_star
            {         
              for(j=Tracking_NUM;j>=0;j--)
              {
                if(leftline[i+1]+j-Tracking_displacement>0&&leftline[i+1]+j+Interval-Tracking_displacement<CAMERA_W)
                {
                  if(imgbuff[i][leftline[i+1]+j+Interval-Tracking_displacement]-imgbuff[i][leftline[i+1]+j-Tracking_displacement]>Jump_threhold&&imgbuff[i][leftline[i+1]+j+Interval-Tracking_displacement]>150&&imgbuff[i][leftline[i+1]+j-Tracking_displacement]<150)
                  {
                    leftline[i]=leftline[i+1]+j-Tracking_displacement;
                    find_line_left=1;
                    break_left_shizi=0;
                    break;
                  }
                  else
                  {
                    find_line_left=0;
                  }
                }
              }
              if(find_line_left==0)
              {
                break_left_shizi=i+1;
                break;
              }
            }
          }
          if(shizi_start_right!=0)
          {
            for(j=shizi_start_mid;j<=CAMERA_W-Interval-1;j++)
            {
              if(imgbuff[shizi_start_right][j]-imgbuff[shizi_start_right][j+Interval]>Jump_threhold&&imgbuff[shizi_start_right][j]>150&&imgbuff[shizi_start_right][j+Interval]<150)
              {
                rightline[shizi_start_right]=j+Interval;
                break;
              }
            }
            break_right_shizi = 39;   
            for(i=shizi_start_right-1;i>=0;i--)  // shizi_star
            {        
              for(j=0;j<=Tracking_NUM;j++)
              {
                if(rightline[i+1]+j-Interval-Tracking_displacement>0&&rightline[i+1]+j-Tracking_displacement<CAMERA_W)
                {
                  if(imgbuff[i][rightline[i+1]+j-Interval-Tracking_displacement]-imgbuff[i][rightline[i+1]+j-Tracking_displacement]>Jump_threhold&&imgbuff[i][rightline[i+1]+j-Interval-Tracking_displacement]>150&&imgbuff[i][rightline[i+1]+j-Tracking_displacement]<150)
                  {
                    rightline[i]=rightline[i+1]+j-Tracking_displacement;
                    find_line_right=1;
                    break_right_shizi=0;
                    break;
                  }
                  else
                  {
                    find_line_right=0;
                  }
                }
              }
              if(find_line_right==0)
              {
                break_right_shizi=i+1;
                break;
              }
            }
          } 
          
          // 开始十字向前补线程序！！
          if(break_left_shizi!=0&&shizi_start_left!=0)
          {
            if(shizi_start_right==0&&shizi_start_left>30)
            {
              slope=(float)(leftline[shizi_start_left-3]+leftline[shizi_start_left-2]-leftline[shizi_start_left-1]-leftline[shizi_start_left])/4;
              for(i=shizi_start_left-3;i>=0;i--)
              {
                leftline[i]=leftline[shizi_start_left-3]+slope*(shizi_start_left-i-3);
              }
            }
            else
            {
              slope=(float)(leftline[break_left_shizi+1]+leftline[break_left_shizi]-leftline[break_left_shizi+3]-leftline[break_left_shizi+2])/4;
              for(i=break_left_shizi+3;i>=0;i--)
              {
                leftline[i]=leftline[break_left_shizi+3]+slope*(break_left_shizi-i+3);
              }
            }
          }
          if(break_right_shizi!=0&&shizi_start_right!=0)
          {
            if(shizi_start_left==0&&shizi_start_right>30)
            {
              slope=(float)(rightline[shizi_start_right-3]+rightline[shizi_start_right-2]-rightline[shizi_start_right-1]-rightline[shizi_start_right])/4;
              for(i=shizi_start_right-3;i>=0;i--)
              {
                rightline[i]=rightline[shizi_start_right-3]+slope*(shizi_start_right-i-3);
              }
            }
            else
            {
              slope=(float)(rightline[break_right_shizi+1]+rightline[break_right_shizi]-rightline[break_right_shizi+3]-rightline[break_right_shizi+2])/4;
              for(i=break_right_shizi+3;i>=0;i--)
              {
                rightline[i]=rightline[break_right_shizi+3]+slope*(break_right_shizi-i+3);
              }
            }
          }
          
          //***************最小二乘法**************//
          if(shizi_start_right-2>break_right_shizi)
          {
            AvaliableLines=3;
            SumX=0;
            SumY=0;
            x_2=0;
            x_y=0;
            
            for(i=shizi_start_right;i>=shizi_start_right-2;i--) 
            {
              SumX=SumX+(i);
              SumY=SumY+rightline[i];
              x_2=x_2+(i)*(i);
              x_y=x_y+i*rightline[i];
            }
            
            AverageX=(float)SumX*1.0/AvaliableLines;
            AverageY=(float)SumY*1.0/AvaliableLines;
            AverageX_2=(float)x_2*1.0/AvaliableLines;
            AverageX_Y=(float)x_y*1.0/AvaliableLines;
            
            b_right=(AverageX_Y-AverageX*AverageY)*100/(AverageX_2-AverageX*AverageX);
            slope_shizi_right =(float)b_right / 100;           
            if(slope_shizi_right<=0.5||slope_shizi_right>=2.6)
            {
              slope_shizi_right=2.0;
            }
            for (i = shizi_start_right ; i <=  CAMERA_R_H - 1; i++)  
            {
              rightline[i] = rightline[shizi_start_right] - slope_shizi_right * (shizi_start_right - i);
            }
          }
          
          if(shizi_start_left-2>break_left_shizi)
          {
            AvaliableLines =3;
            SumX = 0;
            SumY = 0;
            x_2 = 0;
            x_y = 0;
            
            for (i = shizi_start_left;i>=shizi_start_left-2;i--) 
            {
              SumX = SumX + (i);
              SumY = SumY + leftline[i];
              x_2 = x_2 + (i) * (i);
              x_y = x_y + i * leftline[i];
            }
            
            AverageX = (float)SumX * 1.0 / AvaliableLines;
            AverageY = (float)SumY * 1.0 / AvaliableLines;
            AverageX_2 = (float)x_2 * 1.0 / AvaliableLines;
            AverageX_Y = (float)x_y * 1.0 / AvaliableLines;
            
            b_left = (AverageX_Y - AverageX * AverageY) * 100 /(AverageX_2 - AverageX * AverageX);
            slope_shizi_left =(float) b_left/100;        
            if(slope_shizi_left<-2.7||slope_shizi_left>-0.5 )
            {
              slope_shizi_left=-2.1;
            }
            for (i = shizi_start_left; i <=  CAMERA_R_H - 1; i++)   
            {
              leftline[i] = leftline[shizi_start_left] -slope_shizi_left * (shizi_start_left - i);
            }
          }
          if(shizi_start_right-2<=break_right_shizi)                 
          {
            for (i = 0 ; i <=  CAMERA_R_H - 1; i++)  
            {
              rightline[i] =leftline[i]+width[i] ;
            }
          }
          if(shizi_start_left-2<=break_left_shizi)
          {
            for (i = 0; i <=  CAMERA_R_H - 1; i++)   
            {
              leftline[i] = rightline[i]-width[i];
            }
          }
        }
      }
      
      ///前车发送信号不让后车识别环岛   因为在某一状态可能误判
      if(former_flag==1&&(shizi_count==1||shizi_count==3))         //(shizi_count==1||shizi_count==3)
      {
        send_num=3;    
      } 
      
      tiaobian_left=0;
      tiaobian_right=0;
      up_dot_zuo=0;
      up_dot_you=0;
      edge_length1=0;
      edge_length2=0;
      huandao_width2=0;
      huandao_width1=0;
      up_lie_right=0;
      up_lie_left=0;
      count_black1=0;
      count_black2=0;
      xierushizi_flag=0;
      slope_xierushizi=0;
    //  ruhuandao_flag=0;
   
      if((rightline_flag==1||leftline_flag==1) && (abs(break_left-break_right)>4||(break_left>10||break_right>10))&&chuhuandao_flag==1)     //环道和直入十字判断重叠       abs(break_left-break_right)>10！！！！！！！！！！！！！！！！
      { 
        for(i=CAMERA_R_H-3;i>=break_left+2;i--)   
        {
          if(leftline[i]>=leftline[i+1] && leftline[i]>=leftline[i-1] && leftline[i+1]>=leftline[i+2] && leftline[i-1]>=leftline[i-2])
          {
            tiaobian_left=i;
            break;
          }
        }
        for(i=CAMERA_R_H-3;i>=break_right+2;i--)                                  //寻找右边的跳变点
        {
          if(rightline[i]<=rightline[i+1] && rightline[i]<=rightline[i-1] && rightline[i+1]<=rightline[i+2] && rightline[i-1]<=rightline[i-2])
          {
            tiaobian_right=i;
            break;
          }
        }
        
        //***环道判断***//     
        if((break_left>10||break_right>10) && (leftline_flag==1 || rightline_flag==1)&&chuhuandao_flag==1 && qian_shizi_flag==0&&podao_flag==0&&stop_flag==0&&(former_flag==1||(former_flag==0&&ruhuandao_ready==1))&&ruhuandao_flag==0)   //改动了括号/////
        {
          if(tiaobian_left!=0&&(tiaobian_left-break_left)>=2)
          { 
            if(former_flag==1)
            {
              if(tiaobian_left-8>=0)
              {
                if(tiaobian_left-8>break_left)
                {
                  if(tiaobian_left-8<break_right)
                  {
                    for(int i= (leftline[break_right]+rightline[break_right])/2;i<=195;i++)
                    {
                      if(imgbuff[tiaobian_left-8][i]-imgbuff[tiaobian_left-8][i+3]>Jump_threhold&&imgbuff[tiaobian_left-8][i]-imgbuff[tiaobian_left-8][i+4]>Jump_threhold&&imgbuff[tiaobian_left-8][i]>ThreadHold&&imgbuff[tiaobian_left-8][i+3]<ThreadHold)
                      {
                        huan_judge_top1=i+3;                         //rightline[tiaobian_left-8]=i+3;
                        break;
                      }
                      else
                      {
                        huan_judge_top1=199;        //rightline[tiaobian_left-8]=199;
                      }
                    }
                    for(int i= (leftline[39]+rightline[39])/2;i<=195;i++)
                    {
                      if(imgbuff[tiaobian_left+2][i]-imgbuff[tiaobian_left+2][i+3]>Jump_threhold&&imgbuff[tiaobian_left+2][i]-imgbuff[tiaobian_left+2][i+4]>Jump_threhold&&imgbuff[tiaobian_left+2][i]>ThreadHold&&imgbuff[tiaobian_left+2][i+3]<ThreadHold)
                      {
                        huan_judge_bottom1=i+3;                         //rightline[tiaobian_left-8]=i+3;
                        break;
                      }
                      else
                      {
                        huan_judge_bottom1=199;        //rightline[tiaobian_left-8]=199;
                      }
                    }
                  }
                  else
                  {
                    huan_judge_top1=rightline[tiaobian_left-8];
                    huan_judge_bottom1=rightline[tiaobian_left+2];
                  }
                  kuandu_cha1=(huan_judge_top1-leftline[tiaobian_left-8])-(huan_judge_bottom1-leftline[tiaobian_left+2]);
                }
                else
                {
                  if(break_left<break_right)
                  {
                    for(int i= (leftline[break_right]+rightline[break_right])/2;i<=195;i++)
                    {
                      if(imgbuff[break_left][i]-imgbuff[break_left][i+3]>Jump_threhold&&imgbuff[break_left][i]-imgbuff[break_left][i+4]>Jump_threhold&&imgbuff[break_left][i]>ThreadHold&&imgbuff[break_left][i+3]<ThreadHold)
                      {
                        huan_judge_top1=i+3;               //rightline[break_left]=i+3;
                        break;
                      }
                      else
                      {
                        huan_judge_top1=199;           //rightline[break_left]=199;
                      }
                    }
                    for(int i= (leftline[39]+rightline[39])/2;i<=195;i++)
                    {
                      if(imgbuff[tiaobian_left+2][i]-imgbuff[tiaobian_left+2][i+3]>Jump_threhold&&imgbuff[tiaobian_left+2][i]-imgbuff[tiaobian_left+2][i+4]>Jump_threhold&&imgbuff[tiaobian_left+2][i]>ThreadHold&&imgbuff[tiaobian_left+2][i+3]<ThreadHold)
                      {
                        huan_judge_bottom1=i+3;                         //rightline[tiaobian_left-8]=i+3;
                        break;
                      }
                      else
                      {
                        huan_judge_bottom1=199;        //rightline[tiaobian_left-8]=199;
                      }
                    }
                  }
                  else
                  {
                    huan_judge_top1=rightline[break_left];
                    huan_judge_bottom1=rightline[tiaobian_left+2];
                  }
                  kuandu_cha1=(huan_judge_top1-leftline[break_left])-(huan_judge_bottom1-leftline[tiaobian_left+2]);
                }
                if(kuandu_cha1>=20) 
                {
                  ruhuandao_may=1;
                }
                else
                {
                  ruhuandao_may=0;
                }
              }
            }
            else if(former_flag==0&&ruhuandao_ready==1)
            {
              ruhuandao_may=1;
            }
            if(ruhuandao_may==1)
            {
              if(leftline[tiaobian_left]+61>=199)
              {
                leftline[tiaobian_left]=138;
              }
              if(imgbuff[tiaobian_left-5][leftline[tiaobian_left]]>150)
              {
                if(rightline_flag==1)
                {
                  long huan_temp=0;
                  huan_zhongxian_front=0;
                  if(CAMERA_R_H-1-tiaobian_left<=5&&CAMERA_R_H-1-tiaobian_left>0)
                  {
                    slope_huanzuo_judge=Least_Squares(&leftline[0],CAMERA_R_H-tiaobian_left,CAMERA_R_H-1); 
                  }
                  else if(CAMERA_R_H-1-tiaobian_left>5)
                  {
                    slope_huanzuo_judge=Least_Squares(&leftline[0],5,tiaobian_left+5);
                  }
                  if(slope_huanzuo_judge==0)
                  {
                    slope_huanzuo_judge=slope_huanzuo_old;
                  }
                  for(int i=39;i>=0;i--)
                  {
                    huan_leftline[i]=leftline[39]-slope_huanzuo_judge*(39-i)/10;                  
                  }               
                  slope_huanzuo_old=slope_huanzuo_judge;
                  
                  for (int i = 30; i >= 11; i--)
                  {
                    huan_temp = huan_temp + weight[i-11] * (huan_leftline[i] + width[i]+huan_leftline[i]) / 2;
                  }
                  huan_zhongxian_front= huan_temp / 210;
                }
                else
                {
                  long huan_temp=0;
                  huan_zhongxian_front=0;
                  slope_huanzuo_judge=0;
                  if(CAMERA_R_H-1-tiaobian_left<=5&&CAMERA_R_H-1-tiaobian_left>0)
                  {
                    slope_huanzuo_judge=Least_Squares(&leftline[0],CAMERA_R_H-tiaobian_left,CAMERA_R_H-1); 
                  }
                  else if(CAMERA_R_H-1-tiaobian_left>5)
                  {
                    slope_huanzuo_judge=Least_Squares(&leftline[0],5,tiaobian_left+5);
                  }
                  if(slope_huanzuo_judge==0)
                  {
                    slope_huanzuo_judge=slope_huanzuo_old;
                  }
                  for(int i=39;i>=0;i--)
                  {
                    huan_leftline[i]=leftline[39]-slope_huanzuo_judge*(39-i)/10;                  
                  }               
                  slope_huanzuo_old=slope_huanzuo_judge;
                  
                  for(int i=39;i>=0;i--)
                  {
                    huan_leftline[i]=leftline[39]-slope_huanzuo_judge*(39-i)/10;                  
                  }
                  for (int i = 30; i >= 11; i--)
                  {
                    huan_temp = huan_temp + weight[i-11] * huan_leftline[i];
                  }
                  huan_zhongxian_front= huan_temp / 210+60;   ////////////74            
                }
                
                if(huan_zhongxian_front>=3&&huan_zhongxian_front<=196)
                {
                  for(int k=huan_zhongxian_front-3;k<=huan_zhongxian_front+3;k++)
                  {
                    for(i=tiaobian_left-5;i>=13;i--)                
                    {
                      if(imgbuff[i][k]-imgbuff[i-3][k]>Jump_threhold&&imgbuff[i][k]>ThreadHold&&imgbuff[i-3][k]<ThreadHold)
                      {
                        up_lie_left=k;
                        up_dot_zuo=i-3;
                        break;
                      }
                    }
                    if(up_dot_zuo!=0&&up_dot_zuo>=15)
                    {   
                      huandao_width1=abs(up_dot_zuo-tiaobian_left);
                      break;
                    }
                  }
                }
              }
              if(abs(huandao_width1)>=9&&abs(huandao_width1)<=23) 
              {
                if(up_lie_left+5>=199)
                {
                  up_lie_left=194;
                }                
                for(i=up_lie_left-5;i<=up_lie_left+5;i++ )
                {
                  if(imgbuff[up_dot_zuo][i]<150)
                  {
                    count_black1++;
                  }
                  if(count_black1>9)
                  {
                    ruhuandao_flag=1;
                    distance3=0;
                    if(former_flag==1)
                    {
                      send_num=9;
                    }
                    else if(former_flag==0)
                    {
                      ruhuandao_ready=0;
                    }
                    break;
                  }
                }
              }
              ruhuandao_may=0;
            }
          }
          if(tiaobian_right!=0&&(tiaobian_right-break_right)>=2)    
          { 
            if(former_flag==1)
            {   
              if(tiaobian_right-8>=0)
              {
                if(tiaobian_right-8>break_right)
                {
                  if(break_left>tiaobian_right-8)
                  {
                    for(int i= (leftline[break_left]+rightline[break_left])/2;i>=4;i--)
                    {
                      if(imgbuff[tiaobian_right-8][i]-imgbuff[tiaobian_right-8][i-3]>Jump_threhold&&imgbuff[tiaobian_right-8][i]-imgbuff[tiaobian_right-8][i-4]>Jump_threhold&&imgbuff[tiaobian_right-8][i]>ThreadHold&&imgbuff[tiaobian_right-8][i-3]<ThreadHold)
                      {
                        huan_judge_top2=i-3;      //leftline[tiaobian_right-8]=i-3;
                        break;
                      }
                      else
                      {
                        huan_judge_top2=0;      //leftline[tiaobian_right-8]=0;
                      }
                    }        
                    for(int i= (leftline[39]+rightline[39])/2;i>=4;i--)
                    {
                      if(imgbuff[tiaobian_right+2][i]-imgbuff[tiaobian_right+2][i-3]>Jump_threhold&&imgbuff[tiaobian_right+2][i]-imgbuff[tiaobian_right+2][i-4]>Jump_threhold&&imgbuff[tiaobian_right+2][i]>ThreadHold&&imgbuff[tiaobian_right+2][i-3]<ThreadHold)
                      {
                        huan_judge_bottom2=i-3;      //leftline[tiaobian_right-8]=i-3;
                        break;
                      }
                      else
                      {
                        huan_judge_bottom2=0;      //leftline[tiaobian_right-8]=0;
                      }
                    }
                  }
                  else
                  {
                    huan_judge_top2=leftline[tiaobian_right-8];
                    huan_judge_bottom2=leftline[tiaobian_right+2];
                  }
                  kuandu_cha2=(rightline[tiaobian_right-8]-huan_judge_top2)-(rightline[tiaobian_right+2]-huan_judge_bottom2);
                }
                else
                {
                  if(break_right<break_left)
                  {
                    for(int i= (leftline[break_left]+rightline[break_left])/2;i>=4;i--)
                    {
                      if(imgbuff[break_right][i]-imgbuff[break_right][i-3]>Jump_threhold&&imgbuff[break_right][i]-imgbuff[break_right][i-4]>Jump_threhold&&imgbuff[break_right][i]>ThreadHold&&imgbuff[break_right][i-3]<ThreadHold)
                      {
                        huan_judge_top2=i-3;       //leftline[break_right]=i-3;
                        break;
                      }
                      else
                      {
                        huan_judge_top2=0;        //leftline[break_right]=0;
                      }
                    }  
                    for(int i= (leftline[39]+rightline[39])/2;i>=4;i--)
                    {
                      if(imgbuff[tiaobian_right+2][i]-imgbuff[tiaobian_right+2][i-3]>Jump_threhold&&imgbuff[tiaobian_right+2][i]-imgbuff[tiaobian_right+2][i-4]>Jump_threhold&&imgbuff[tiaobian_right+2][i]>ThreadHold&&imgbuff[tiaobian_right+2][i-3]<ThreadHold)
                      {
                        huan_judge_bottom2=i-3;      //leftline[tiaobian_right-8]=i-3;
                        break;
                      }
                      else
                      {
                        huan_judge_bottom2=0;      //leftline[tiaobian_right-8]=0;
                      }
                    }
                  }
                  else
                  {
                    huan_judge_top2=leftline[break_right];
                    huan_judge_bottom2=leftline[tiaobian_right+2];
                  }
                  kuandu_cha2=(rightline[break_right]-huan_judge_top2)-(rightline[tiaobian_right+2]-huan_judge_bottom2);
                }
                if(kuandu_cha2>=20) 
                { 
                  ruhuandao_may=1;
                }
                else
                {
                  ruhuandao_may=0;
                }
              }
            }
            else if(former_flag==0&&ruhuandao_ready==1)
            {
              ruhuandao_may=1;
            }
            if(ruhuandao_may==1)
            {
              if(rightline[tiaobian_right]-61<=0)
              {
                rightline[tiaobian_right]=61;       
              }
              if(imgbuff[tiaobian_right-5][rightline[tiaobian_right]]>150)
              {
                if(leftline_flag==1)
                {
                  long  huan_temp=0;
                  huan_zhongxian_front=0;
                  slope_huanyou_judge=0;
                  if(CAMERA_R_H-1-tiaobian_right<=5&&CAMERA_R_H-1-tiaobian_right>0)
                  {
                    slope_huanyou_judge=Least_Squares(&rightline[0],CAMERA_R_H-tiaobian_right,CAMERA_R_H-1); 
                  }
                  else if(CAMERA_R_H-1-tiaobian_right>5)
                  {
                    slope_huanyou_judge=Least_Squares(&rightline[0],5,tiaobian_right+5); 
                  } 
                  if(slope_huanyou_judge==0)
                  {
                    slope_huanyou_judge=slope_huanyou_old;
                  }  
                  for(int i=39;i>=0;i--)
                  {       
                    huan_rightline[i]=rightline[39]-slope_huanyou_judge*(39-i)/10;                  
                  }
                  slope_huanyou_old=slope_huanyou_judge;
                  
                  for (int i = 30 ;i >= 11; i--)
                  {
                    huan_temp = huan_temp + weight[i-11] * (huan_rightline[i] -width[i]+huan_rightline[i]) / 2;
                  }
                  huan_zhongxian_front= huan_temp / 210;
                }
                else
                {
                  long  huan_temp=0;
                  huan_zhongxian_front=0;
                  if(CAMERA_R_H-1-tiaobian_right<=5&&CAMERA_R_H-1-tiaobian_right>0)
                  {
                    slope_huanyou_judge=Least_Squares(&rightline[0],CAMERA_R_H-tiaobian_right,CAMERA_R_H-1); 
                  }
                  else if(CAMERA_R_H-1-tiaobian_right>5)
                  {
                    slope_huanyou_judge=Least_Squares(&rightline[0],5,tiaobian_right+5); 
                  }                
                  if(slope_huanyou_judge==0)
                  {
                    slope_huanyou_judge=slope_huanyou_old;
                  }  
                  for(int i=39;i>=0;i--)
                  {       
                    huan_rightline[i]=rightline[39]-slope_huanyou_judge*(39-i)/10;                  
                  }
                  slope_huanyou_old=slope_huanyou_judge;
                  
                  for (int i = 30 ;i >= 11; i--)
                  {
                    huan_temp = huan_temp + weight[i-11] *huan_rightline[i];
                  }
                  huan_zhongxian_front= huan_temp / 210-60;                  
                }
                if(huan_zhongxian_front>=3&&huan_zhongxian_front<=196)
                {         
                  for(int k=huan_zhongxian_front+3;k>=huan_zhongxian_front-3;k--)
                  {
                    for(i=tiaobian_right-5;i>=13;i--)
                    { 
                      if(imgbuff[i][k]-imgbuff[i-3][k]>Jump_threhold&&imgbuff[i][k]>ThreadHold&&imgbuff[i-3][k]<ThreadHold)
                      {
                        up_lie_right=k;
                        up_dot_you=i-3;
                        break;
                      }
                    }  
                    if(up_dot_you!=0&&up_dot_you>=15)
                    {
                      huandao_width2=abs(up_dot_you-tiaobian_right);
                      break;
                    } 
                  } 
                }
              }
              if(abs(huandao_width2)>=9&&abs(huandao_width2)<=23) //9
              {
                if(up_lie_right-5<=0)
                {
                  up_lie_right=5;
                }
                for(i=up_lie_right+5;i>=up_lie_right-5;i--)
                {
                  if(imgbuff[up_dot_you][i]<150)
                  {
                    count_black2++;
                  }
                  if(count_black2>9)
                  {
                    ruhuandao_flag=1;
                    distance3=0;
                    if(former_flag==1)
                    {
                      send_num=9;
                    }
                    else if(former_flag==0)
                    {
                      ruhuandao_ready=0;
                    }
                    break;
                  }
                }
              }
              ruhuandao_may=0;
            }
          }
        }
        
        //************斜入十字判断*******************//
        if(ruhuandao_flag!=1 &&shizi_count!=1&&shizi_count!=3&& chuhuandao_flag==1)      //  !!!!!!     shizi_count!=1&&shizi_count!=3
        {       
          if(rightline_flag==1 && break_left-break_right>4)          //5   !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
          {
            if(tiaobian_right!=0)
            {
              slope1=(float)(rightline[tiaobian_right]-rightline[CAMERA_R_H-1])/(CAMERA_R_H-1-tiaobian_right);
              if(tiaobian_right-break_right>=5)
              {
                slope2=(float)(rightline[tiaobian_right-5]-rightline[tiaobian_right])/5;
              }
              else
              {
                slope2=(float)(rightline[break_right]-rightline[tiaobian_right])/(tiaobian_right-break_right);                  
              }
              
              if(abs(slope1-slope2)>=6&&slope1*slope2<0)////////&& (abs(slope1)<abs(slope2))
              {
                xierushizi_flag=2;
                break_right=tiaobian_right;
              }
            }
            else
            {
              if(break_right<=35)
              {
                slope_you_shizi=Least_Squares(&rightline[0],5,CAMERA_R_H-1);
              }
              else if(break_right<=38&&break_right>35)
              {
                slope_you_shizi=Least_Squares(&rightline[0],CAMERA_R_H-break_right,CAMERA_R_H-1);
              }
              if(slope_you_shizi<0)
              {
                xieshizi_left_tiaobian=0;
                for(int i=rightline[39];i>=3;i--) 
                {
                  if(imgbuff[break_right+2][i]-imgbuff[break_right+2][i-3]>Jump_threhold&&imgbuff[break_right+2][i]>150&&imgbuff[break_right+2][i-3]<150)
                  {
                    xieshizi_left_tiaobian=i-3;  
                    break;
                  }
                  else
                  {
                    xieshizi_left_tiaobian=0;
                  }
                }
                if(xieshizi_left_tiaobian==0)
                {
                  xierushizi_flag=4;
                }
                else  
                {
                  xierushizi_flag=0;
                }
              }
            }
          }   
          
          if(break_right-break_left>4 && leftline_flag==1)                               //右转斜入十字
          {
            if(tiaobian_left!=0)
            {
              slope1=(float)(leftline[tiaobian_left]-leftline[CAMERA_R_H-1])/(CAMERA_R_H-1-tiaobian_left);
              if(tiaobian_left-break_left>=5)          
              {
                slope2=(float)(leftline[tiaobian_left-5]-leftline[tiaobian_left])/5;
              }
              else
              {
                slope2=(float)(leftline[break_left]-leftline[tiaobian_left])/(tiaobian_left-break_left);
              }
              
              if(abs(slope1-slope2)>=6 && slope1*slope2<0)  ///////&& (abs(slope1)<abs(slope2))
              {
                xierushizi_flag=1;
                break_left=tiaobian_left;           ////?????????????????????????????????????????????
              }
            }
            else
            {
              if(break_left<=35)
              {
                slope_zuo_shizi=Least_Squares(&leftline[0],5,CAMERA_R_H-1);
              }
              else if(break_left<=38&&break_left>35)
              {
                slope_zuo_shizi=Least_Squares(&leftline[0],CAMERA_R_H-break_right,CAMERA_R_H-1);
              }
              if(slope_zuo_shizi>0)
              {
                xieshizi_right_tiaobian=0;
                for(int i=leftline[39];i<=196;i++)
                {
                  if(imgbuff[break_left+2][i]-imgbuff[break_left+2][i+3]>Jump_threhold&&imgbuff[break_left+2][i]>150&&imgbuff[break_left+2][i+3]<150)
                  {
                    xieshizi_right_tiaobian=i+3;
                    break;
                  }
                  else
                  {
                    xieshizi_right_tiaobian=0;
                  }
                }
                if(xieshizi_right_tiaobian==0)
                {
                  xierushizi_flag=3;
                }
                else
                {
                  xierushizi_flag=0;
                }
              }
            }
          }
        }
      }         
      
      //左转入环岛
      if(ruhuandao_flag==1&&chuhuandao_flag==1&&huandao[huandao_count]==1)
      {  
        if(leftline_flag!=0)
        {
          if(break_left<=37)
          {
            slope_chuhuan_zuo=Least_Squares(&leftline[0],3,break_left+2);
            if(slope_chuhuan_zuo<=3)
            {
              slope_chuhuan_zuo=5;   //5
            }
            if(slope_chuhuan_zuo>=30)    //35
            {
              slope_chuhuan_zuo=30;
            }
            for(int i=break_left+2;i>=0;i--)           
            {
              leftline[i]=leftline[break_left+2]-slope_chuhuan_zuo*(break_left+2-i)/10;    ///////////slope_chuhuan_zuo  
            }
          }  
          if(rightline_flag!=0)   ////////////////&&huan_you_flag==0
          {
            for(i=0;i<=CAMERA_R_H-1;i++)       
            {   
              rightline[i]=leftline[i]+width[i]+10;    /////////左边出环以左边线跑
            }
          }
          else if(rightline_flag==0)     ////////&&huan_you_flag==0
          {
            for(i=0;i<=CAMERA_R_H-1;i++)       
            {   
              rightline[i]=leftline[i]+width[i]+30;    /////////左边出环以左边线跑
            } 
          }
        }
        else  
        {
          if(zhongxian_front[0]>4&&zhongxian_front[0]<199)
          {
            zuo_ruhuan_start=zhongxian_front[0];
          }
          else if(midline[39]>4&&midline[39]<199)
          {
            zuo_ruhuan_start=midline[39];
          }
          else
          {
            zuo_ruhuan_start=100;
          }
          ruhuan_diu_count=0;
          for(i=CAMERA_R_H-3;i>=20;i--)  
          {
            for(j=zuo_ruhuan_start;j>=4;j--)
            {
              if(imgbuff[i][j]-imgbuff[i][j-3]>Jump_threhold && imgbuff[i][j]-imgbuff[i][j-4]>Jump_threhold&&imgbuff[i][j]>150&&imgbuff[i][j-3]<150  )
              {
                if(ruhuan_diu_count==0)
                {
                  ruhuan_diu_count++;
                  if(ruhuan_diu_count==1)
                  {
                    ruhuan_find_left = i;
                  }
                }
                leftline[i]=j-3; 
                ruhuan_break_left=20;
                find_line_left=1;
                break;
              }
              else
              {
                find_line_left = 0;
              }
            } 
            if(find_line_left==0&&ruhuan_diu_count==1)
            {
              ruhuan_break_left=i+1;
              break;
            }
          } 
          if(ruhuan_find_left-ruhuan_break_left>=3)
          {
            slope_ruhuan_zuo=Least_Squares(&leftline[0],ruhuan_find_left+1-ruhuan_break_left,ruhuan_find_left);
            if(slope_ruhuan_zuo<=3)
            {
              slope_chuhuan_zuo=5;   //5
            }
            if(slope_chuhuan_zuo>=30)  //35
            {
              slope_chuhuan_zuo=30;
            }
            for(i=ruhuan_break_left+2;i>=0;i--)          
            {
              leftline[i]=slope_chuhuan_zuo*(ruhuan_break_left-i+2)/10+leftline[ruhuan_break_left+2];  
            }
          }
          if(rightline_flag!=0&&ruhuan_diu_count==1)  /////&&huan_you_flag==0
          {
            for(i=0;i<=CAMERA_R_H-1;i++)      ///////buxian!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
            {   
              rightline[i]=leftline[i]+width[i];    /////////左边出环以左边线跑
            } 
          }
          else  if(rightline_flag==0&&ruhuan_diu_count==1) ///// &&huan_you_flag==0
          {
            for(i=0;i<=CAMERA_R_H-1;i++)      ///////buxian!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
            {   
              rightline[i]=leftline[i]+width[i]+20;    /////////左边出环以左边线跑
            } 
          }
          if(ruhuan_diu_count==0)
          {
            if(rightline_flag==0)
            {
              youruhuan_diu_count=0;
              youruhuan_diu_find=0;
              for(i=15;i<=Last_line;i++)  
              {
                for(j= 0;j<=CAMERA_W-5;j++)
                {
                  if(imgbuff[i][j]-imgbuff[i][j+3]>Jump_threhold && imgbuff[i][j]-imgbuff[i][j+4]>Jump_threhold &&imgbuff[i][j]>150&&imgbuff[i][j+3]<150 )
                  {
                    if(youruhuan_diu_count==0)
                    {
                      youruhuan_diu_count++;
                      if(youruhuan_diu_count==1)
                      {
                        youruhuan_diu_find = i;
                      }
                    }
                    rightline[i]=j+3; 
                    find_line_right=1;
                    break;
                  }
                  else
                  {
                    find_line_right = 0;
                  }
                }  
                if(youruhuan_diu_count==1&&find_line_right==1)
                {
                  break;
                }
              }
              if(youruhuan_diu_find!=0)
              {
                slope_ruhuan_diu_you=(float)(rightline[youruhuan_diu_find]-199)/(youruhuan_diu_find-39);
                if(slope_ruhuan_diu_you<6)
                {
                  slope_ruhuan_diu_you=6;               
                }
                for(int i=39;i>=0;i--)   
                {
                  rightline[i]=-slope_ruhuan_diu_you*(39-i)+199;  // 10
                  leftline[i]=rightline[i]-width[i]-20;
                }
              }
              //              }
            }
            else
            {
              for(int i=CAMERA_R_H-1;i>=0;i--)       /////////!!!!!!!!!!!!!
              {
                leftline[i]=rightline[i]-width[i]-30;
              }
            }
          }
        }          
      }
      
      //右转入环岛
      if(ruhuandao_flag==1&&chuhuandao_flag==1&&huandao[huandao_count]==0)
      {   
        if(rightline_flag!=0)
        { 
          if(break_right<=37)
          {
            slope_ruhuan_you=Least_Squares(&rightline[0],3,break_right+2);
            if(slope_ruhuan_you>=-7)
            {
              slope_ruhuan_you=-15;
            }
            if(slope_ruhuan_you<=-33)
            {
              slope_ruhuan_you=-33;
            }
            for(i=break_right+2;i>=0;i--)       //    4
            {
              rightline[i]=rightline[break_right+2]-slope_ruhuan_you*(break_right-i+2)/10;  // 10
            }  
          }
          if(leftline_flag!=0)   //////////////&&huan_zuo_flag==0
          {
            for(i=0;i<=CAMERA_R_H-1;i++)    
            {
              leftline[i]=rightline[i]-width[i];
            }
          }
          else if(leftline_flag==0)      ///////////////&&huan_zuo_flag==0
          {
            for(i=0;i<=CAMERA_R_H-1;i++)    
            {
              leftline[i]=rightline[i]-width[i]-20;
            }
          }
        }
        else
        {
          if(zhongxian_front[0]>0&&zhongxian_front[0]<195)
          {
            you_ruhuan_start=zhongxian_front[0];
          }
          else   if(midline[39]>0&&midline[39]<195)
          {
            you_ruhuan_start=midline[39];
          }
          else
          {
            you_ruhuan_start=100;
          }
          ruhuan_diu_count=0;
          for(i=CAMERA_R_H-3;i>=20;i--)  
          {
            for(j= you_ruhuan_start;j<=CAMERA_W-5;j++)
            {
              if(imgbuff[i][j]-imgbuff[i][j+3]>Jump_threhold && imgbuff[i][j]-imgbuff[i][j+4]>Jump_threhold&& imgbuff[i][j]>150&&imgbuff[i][j+3]<150 )
              {
                if(ruhuan_diu_count==0)
                {
                  ruhuan_diu_count++;
                  if(ruhuan_diu_count==1)
                  {
                    ruhuan_find_right = i;
                  }
                }
                rightline[i]=j+3; 
                ruhuan_break_right=20;
                find_line_right=1;
                break;
              }
              else
              {
                find_line_right = 0;
              }
            } 
            if(find_line_right==0&&ruhuan_diu_count==1)
            {
              ruhuan_break_right=i+1;
              break;
            }
          } 
          if(ruhuan_find_right-ruhuan_break_right>=3)
          {
            slope_ruhuan_you=Least_Squares(&rightline[0],ruhuan_find_right+1-ruhuan_break_right,ruhuan_find_right);
            if(slope_ruhuan_you>=-7)
            {
              slope_ruhuan_you=-15;
            }
            if(slope_ruhuan_you<=-30)
            {
              slope_ruhuan_you=-30;
            }
            for(i=ruhuan_break_right+2;i>=0;i--)       //    4
            {
              rightline[i]=slope_ruhuan_you*(ruhuan_break_right-i+2)/10+rightline[ruhuan_break_right+2];  // 10
            } 
          } 
          if(leftline_flag!=0&&ruhuan_diu_count==1)  /////////////&&huan_zuo_flag==0
          {
            for(i=0;i<=CAMERA_R_H-1;i++)    
            {
              leftline[i]=rightline[i]-width[i];
            }
          }
          else if(leftline_flag==0&&ruhuan_diu_count==1)   ///////////////&&huan_zuo_flag==0
          {
            for(i=0;i<=CAMERA_R_H-1;i++)           
            {
              leftline[i]=rightline[i]-width[i]-20;
            }
          }
          if(ruhuan_diu_count==0)
          { 
            if(leftline_flag==0)
            {
              zuoruhuan_diu_count=0;
              zuoruhuan_diu_find=0;
              for(i=15;i<=Last_line;i++)  
              {
                for(j=199;j>=4;j--)
                {
                  if(imgbuff[i][j]-imgbuff[i][j-3]>Jump_threhold && imgbuff[i][j]-imgbuff[i][j-4]>Jump_threhold &&imgbuff[i][j]>150&&imgbuff[i][j-3]<150 )
                  {
                    if(zuoruhuan_diu_count==0)
                    {
                      zuoruhuan_diu_count++;
                      if(zuoruhuan_diu_count==1)
                      {
                        zuoruhuan_diu_find = i;
                      }
                    }
                    leftline[i]=j-3; 
                    find_line_left=1;
                    break;
                  }
                  else
                  {
                    find_line_left = 0;
                  }
                }  
                if(find_line_left==1&&zuoruhuan_diu_count==1)
                {
                  break;
                }
              }
              if(zuoruhuan_diu_find!=0)
              { 
                slope_ruhuan_diu_zuo=(float)(leftline[zuoruhuan_diu_find]-1)/(zuoruhuan_diu_find-39);
                if(slope_ruhuan_diu_zuo>-6)
                {
                   slope_ruhuan_diu_zuo=-6;
                }
                for(int i=39;i>=0;i--)    
                {
                  leftline[i]=1-slope_ruhuan_diu_zuo*(39-i);  // 10
                  rightline[i]=leftline[i]+width[i]+20;                 
                }
              }
            }
            else
            {
              for(int i=CAMERA_R_H-1;i>=0;i--)   
              {
                rightline[i]=leftline[i]+width[i]+30;
              }
            }
          }          
        }
      }
      
      //********斜入十字补线 *******// 
      if(xierushizi_flag==1)                         //左斜入十字补线！
      {
        if(Last_line-tiaobian_left>5)
        {
          slope_xieshizi_zuo=Least_Squares(&leftline[0],5,tiaobian_left+4);
        }
        else if(Last_line-tiaobian_left>0&&Last_line-tiaobian_left<=5)
        {
          slope_xieshizi_zuo=Least_Squares(&leftline[0],Last_line-tiaobian_left+1,Last_line);
        } 
        for(i=tiaobian_left+2;i>=0;i--)
        {
          leftline[i]=leftline[tiaobian_left+2]-slope_xieshizi_zuo*(tiaobian_left-i+2)/10;      //tiaobian-i+2
        }
        if(break_right<=35)
        {  
          slope_xierushizi=Least_Squares(&rightline[0],CAMERA_R_H-break_right,CAMERA_R_H-1);
          for(i=break_right+2;i>=0;i--)       //break_left+3
          {
            rightline[i]=rightline[break_right+2]-slope_xierushizi/10*(break_right-i+2);       ////转向不够加5
          }
        }
        else 
        {
          for(i=break_right;i>=0;i--)
          {
            rightline[i]=leftline[i]+width[i]+12;
          }
        }
      }
      else if(xierushizi_flag==2)                    //右斜入十字补线！
      {
        if(Last_line-tiaobian_right>5)
        {
          slope_xieshizi_you=Least_Squares(&rightline[0],5,tiaobian_right+4);
        }
        else if(Last_line-tiaobian_right>0&&Last_line-tiaobian_right<=5)
        {
          slope_xieshizi_you=Least_Squares(&rightline[0],Last_line-tiaobian_right+1,Last_line);
        }       
        for(i=tiaobian_right+2;i>=0;i--)
        {
          rightline[i]=rightline[tiaobian_right+2]-slope_xieshizi_you*(tiaobian_right-i+2)/10;   //tiaobian-i+2
        }
        if(break_left<=35)
        {
          slope_xierushizi=Least_Squares(&leftline[0],CAMERA_R_H-break_left,CAMERA_R_H-1);
          for(i=break_left+2;i>=0;i--)  //break_right+3
          {
            leftline[i]=leftline[break_left+2]-slope_xierushizi/10*(break_left-i+2);     //转向不够加5
          }
        }
        else
        {
          for(i=break_left;i>=0;i--)
          {
            leftline[i]=rightline[i]-width[i]-12;
          }
        }
      }
      else if(xierushizi_flag==3)/////////车子以很倾斜的姿态左转进入十字
      {
        /*********************先找左右线的基准点************************/
        xieshizi_find_right=0;
        xieshizi_youdiu_count=0;
        xieshizi_break_right=39;
        shizi_start_mid=leftline[CAMERA_R_H-1]+100;
        for(int i=Last_line;i>=15;i--)    ////不能太往前，太靠前会扫描到环岛，左线就不对了
        {
          for(int j=195;j>=shizi_start_mid;j--)
          {            
            if(imgbuff[i][j]-imgbuff[i][j+3]>Jump_threhold&&imgbuff[i][j]-imgbuff[i][j+4]>Jump_threhold&&imgbuff[i][j]>150&&imgbuff[i][j+3]<150)
            {
              if(xieshizi_youdiu_count==0)
              {
                xieshizi_youdiu_count++;
                if(xieshizi_youdiu_count==1)
                {
                  xieshizi_find_right = i;
                }
              }
              rightline[i]=j+3; 
              xieshizi_break_right=15;
              find_line_right=1;
              break;
            }
            else
            {
              find_line_right=0;
            }            
          }
          if(find_line_right==0&&xieshizi_youdiu_count==1)
          {
            xieshizi_break_right=i+1;
            break;
          }          
        } 
        if(xieshizi_youdiu_count==1)
        {
          xieshizi_find_left=0;
          xieshizi_zuodiu_count=0;
          xieshizi_break_left=39;
          for(int i=xieshizi_find_right;i>=15;i--)
          {
            for(int j=rightline[xieshizi_find_right];j>=4;j--)
            {             
              if(imgbuff[i][j]-imgbuff[i][j-3]>Jump_threhold && imgbuff[i][j]-imgbuff[i][j-4]>Jump_threhold&&imgbuff[i][j]>150&&imgbuff[i][j-3]<150  )
              {
                if(xieshizi_zuodiu_count==0)
                {
                  xieshizi_zuodiu_count++;
                  if(xieshizi_zuodiu_count==1)
                  {
                    xieshizi_find_left = i;
                  }
                }
                leftline[i]=j-3; 
                xieshizi_break_left=15;
                find_line_left=1;
                break;
              }
              else
              {
                find_line_left = 0;
              }
            }  
            if(find_line_left==0&&xieshizi_zuodiu_count==1)
            {
              xieshizi_break_left=i+1;
              break;
            }            
          }          
        }
        else if(xieshizi_youdiu_count==0)
        {
          if(break_left>=5)
          {
            xieshizi_zuodiu_count=0;
            xieshizi_find_left=0;
            xieshizi_break_left=39;
            for(int i=break_left-2;i>=0;i--)   
            {
              for(int j=199;j>=leftline[39];j--)
              {
                if(imgbuff[i][j]-imgbuff[i][j-3]>Jump_threhold&&imgbuff[i][j]>150&&imgbuff[i][j-3]<150)
                {
                  if(xieshizi_zuodiu_count==0)
                  {
                    xieshizi_zuodiu_count++;
                    if(xieshizi_zuodiu_count==1)
                    {
                      xieshizi_find_left = i;
                    }
                  }
                  leftline[i]=j-3; 
                  xieshizi_break_left=0;
                  find_line_left=1;
                  break;                 
                }  
                else
                {
                  find_line_left=0;
                }                
              }
              if(xieshizi_zuodiu_count==1&& find_line_left==0) 
              {
                xieshizi_break_left=i+1;
                break;
              }
            }
          }
        }
        /*************斜入十字重新进行左右线往上跟踪****************/
        if( xieshizi_zuodiu_count==1 )
        {
          xieshizi_rebreak_left=39;
          for (int i = xieshizi_break_left; i >= 0; i--) // 40
          {
            for (j = Tracking_NUM; j >= 0; j--) ///    18
            {
              if (leftline[i + 1] + j  - Tracking_displacement >= 0 &&leftline[i + 1] + j+ Interval - Tracking_displacement <CAMERA_W) //   9
              {
                if (imgbuff[i][leftline[i + 1] + j+ Interval -Tracking_displacement] -imgbuff[i][leftline[i + 1] + j- Tracking_displacement] > (Jump_threhold - 0.3 * (39 - i))&&imgbuff[i][leftline[i + 1] + j+ Interval -Tracking_displacement]>150&&imgbuff[i][leftline[i + 1] + j- Tracking_displacement]<150) //  0.3
                {
                  leftline[i] = leftline[i + 1] + j - Tracking_displacement;
                  find_line_left = 1;
                  xieshizi_rebreak_left = 0;
                  break;
                }
                else
                {
                  find_line_left = 0;
                }
              }
            }
            if (find_line_left == 0)
            {
              xieshizi_rebreak_left = i+1;
              break;
            }
          }
        }
        if(xieshizi_youdiu_count==1)
        {
          if(xieshizi_find_right-xieshizi_break_right>=3)
          {
            xieshizi_you_restart=xieshizi_find_right-3;
          }
          else if(xieshizi_find_right-xieshizi_break_right<3&&xieshizi_find_right-xieshizi_break_right>=0)
          {
            xieshizi_you_restart=xieshizi_break_right;
          }
          xieshizi_rebreak_right=39;
          for (int i = xieshizi_you_restart; i >= 0; i--)
          {
            for (j = 0; j <= Tracking_NUM; j++) //  18
            {
              if (rightline[i + 1] + j -Interval- Tracking_displacement >= 0 &&rightline[i + 1] + j - Tracking_displacement< CAMERA_W)
              {
                if (imgbuff[i][rightline[i + 1] + j-Interval - Tracking_displacement] -imgbuff[i][rightline[i + 1] + j - Tracking_displacement ] >(Jump_threhold - 0.3 * (39 - i))&&imgbuff[i][rightline[i + 1] + j-Interval - Tracking_displacement]>150&&imgbuff[i][rightline[i + 1] + j - Tracking_displacement ]<150)       // gai imgbuff[i][rightline[i + 1] + j - Tracking_displacement -Interval] -imgbuff[i][rightline[i + 1] + j - Tracking_displacement] >(Jump_threhold - 0.3 * (39 - i))
                {
                  rightline[i] = rightline[i + 1] + j - Tracking_displacement;
                  find_line_right = 1;
                  xieshizi_rebreak_right = 0;
                  break;
                }
                else
                {
                  find_line_right = 0;
                }
              }
            }
            if (find_line_right == 0)
            {
              xieshizi_rebreak_right = i+1;
              break;
            }
          }              
        }    
        
        //左线往后补线
        if(xieshizi_find_left-xieshizi_rebreak_left>=5)
        {
          slpoe_xieshizi_leftback=Least_Squares(&leftline[0],5,xieshizi_find_left);
          for(int i=xieshizi_find_left-2;i<=39;i++)
          {
            leftline[i] = leftline[xieshizi_find_left-2] - slpoe_xieshizi_leftback * (xieshizi_find_left-2 - i)/10;   
          }
        }
        else if(xieshizi_find_left-xieshizi_rebreak_left<5&&xieshizi_find_left-xieshizi_rebreak_left>0)
        {
          slpoe_xieshizi_leftback=Least_Squares(&leftline[0],xieshizi_find_left-xieshizi_rebreak_left+1,xieshizi_find_left);
          for(int i=xieshizi_find_left;i<=39;i++)
          {
            leftline[i] = leftline[xieshizi_find_left] - slpoe_xieshizi_leftback * (xieshizi_find_left - i)/10;
          }
        }
        //左线往前补线
        if(xieshizi_find_left-xieshizi_rebreak_left>=5)
        {
          slpoe_xieshizi_leftfront=Least_Squares(&leftline[0],5,xieshizi_rebreak_left+4);
          for(int i=xieshizi_rebreak_left+2;i>=0;i--)
          {
            leftline[i] = leftline[xieshizi_rebreak_left+2] - slpoe_xieshizi_leftfront * (xieshizi_rebreak_left+2 - i)/10;
          }
        }
        else   if(xieshizi_find_left-xieshizi_rebreak_left<5&&xieshizi_find_left-xieshizi_rebreak_left>0)
        {
          slpoe_xieshizi_leftfront=Least_Squares(&leftline[0],xieshizi_find_left-xieshizi_rebreak_left+1,xieshizi_find_left);
          for(int i=xieshizi_rebreak_left;i>=0;i--)
          {
            leftline[i] = leftline[xieshizi_rebreak_left] - slpoe_xieshizi_leftfront * (xieshizi_rebreak_left- i)/10;
          }
        }
        //右线补线
        if(xieshizi_youdiu_count==1)
        {
          if(xieshizi_find_right-xieshizi_rebreak_right>=5)
          {
            slpoe_xieshizi_rightback=Least_Squares(&rightline[0],5,xieshizi_find_right);
            for(int i=xieshizi_find_right-2;i<=39;i++)
            {
              rightline[i] = rightline[xieshizi_find_right-2] -slpoe_xieshizi_rightback * (xieshizi_find_right-2 - i)/10;
            }
            slpoe_xieshizi_rightfront=Least_Squares(&rightline[0],5,xieshizi_rebreak_right+4);
            for(int i=xieshizi_rebreak_right+2;i>=0;i--)
            {
              rightline[i] = rightline[xieshizi_rebreak_right+2] -slpoe_xieshizi_rightfront * (xieshizi_rebreak_right+2 - i)/10;
            }            
          }          
          else
          {
            for(int i=39;i>=0;i--)
            {
              rightline[i]=leftline[i]+width[i];   
            }
          }
        }
        else if(xieshizi_youdiu_count==0)
        {
          for(int i=39;i>=0;i--)
          {
            rightline[i]=leftline[i]+width[i];   
          }
        }        
      }
      else if(xierushizi_flag==4)     /////////车子以很倾斜的姿态右转进入十字
      {
        /*********************先找左右线的基准点************************/
        xieshizi_find_left=0;
        xieshizi_zuodiu_count=0;
        xieshizi_break_left=39;
        shizi_start_mid=rightline[CAMERA_R_H-1]-100;
        for(int i=Last_line;i>=15;i--)    ////不能太往前，太靠前会扫描到环岛，左线就不对了
        {
          for(int j=1;j<=shizi_start_mid;j++)
          {            
            if(imgbuff[i][j+3]-imgbuff[i][j]>Jump_threhold&&imgbuff[i][j+3]-imgbuff[i][j-1]>Jump_threhold&&imgbuff[i][j+3]>150&&imgbuff[i][j]<150)
            {
              if(xieshizi_zuodiu_count==0)
              {
                xieshizi_zuodiu_count++;
                if(xieshizi_zuodiu_count==1)
                {
                  xieshizi_find_left = i;
                }
              }
              leftline[i]=j; 
              xieshizi_break_left=15;
              find_line_left=1;
              break;
            }
            else
            {
              find_line_left=0;
            }            
          }
          if(find_line_left==0&&xieshizi_zuodiu_count==1)
          {
            xieshizi_break_left=i+1;
            break;
          }          
        } 
        if(xieshizi_zuodiu_count==1)
        {
          xieshizi_find_right=0;
          xieshizi_youdiu_count=0;
          xieshizi_break_right=39;
          for(int i=xieshizi_find_left;i>=15;i--)
          {
            for(int j=leftline[xieshizi_find_left];j<=195;j++)
            {             
              if(imgbuff[i][j]-imgbuff[i][j+3]>Jump_threhold && imgbuff[i][j]-imgbuff[i][j+4]>Jump_threhold&&imgbuff[i][j]>150&&imgbuff[i][j+3]<150  )
              {
                if(xieshizi_youdiu_count==0)
                {
                  xieshizi_youdiu_count++;
                  if(xieshizi_youdiu_count==1)
                  {
                    xieshizi_find_right = i;
                  }
                }
                rightline[i]=j+3; 
                xieshizi_break_right=15;
                find_line_right=1;
                break;
              }
              else
              {
                find_line_right = 0;
              }
            }  
            if(find_line_right==0&&xieshizi_youdiu_count==1)
            {
              xieshizi_break_right=i+1;
              break;
            }            
          }          
        }
        else if(xieshizi_zuodiu_count==0)
        {
          if(break_right>=5)
          {
            xieshizi_youdiu_count=0;
            xieshizi_find_right=0;
            xieshizi_break_right=39;
            for(int i=break_right-2;i>=0;i--)   
            {
              for(int j=0;j<=rightline[39];j++)
              {
                if(imgbuff[i][j]-imgbuff[i][j+3]>Jump_threhold&&imgbuff[i][j]>150&&imgbuff[i][j+3]<150)
                {
                  if(xieshizi_youdiu_count==0)
                  {
                    xieshizi_youdiu_count++;
                    if(xieshizi_youdiu_count==1)
                    {
                      xieshizi_find_right = i;
                    }
                  }
                  rightline[i]=j+3; 
                  xieshizi_break_right=0;
                  find_line_right=1;
                  break;                 
                }  
                else
                {
                  find_line_right=0;
                }                
              }
              if(xieshizi_youdiu_count==1&& find_line_right==0) 
              {
                xieshizi_break_right=i+1;
                break;
              }
            }
          }
        }
        /*************斜入十字重新进行左右线往上跟踪****************/
        if( xieshizi_zuodiu_count==1 )
        {
          xieshizi_rebreak_left=39;
          for (int i = xieshizi_break_left; i >= 0; i--) // 40
          {
            for (j = Tracking_NUM; j >= 0; j--) ///    18
            {
              if (leftline[i + 1] + j  - Tracking_displacement >= 0 &&leftline[i + 1] + j+ Interval - Tracking_displacement <CAMERA_W) //   9
              {
                if (imgbuff[i][leftline[i + 1] + j+ Interval -Tracking_displacement] -imgbuff[i][leftline[i + 1] + j- Tracking_displacement] > (Jump_threhold - 0.3 * (39 - i))&&imgbuff[i][leftline[i + 1] + j+ Interval -Tracking_displacement]>150&&imgbuff[i][leftline[i + 1] + j- Tracking_displacement]<150) //  0.3
                {
                  leftline[i] = leftline[i + 1] + j - Tracking_displacement;
                  find_line_left = 1;
                  xieshizi_rebreak_left = 0;
                  break;
                }
                else
                {
                  find_line_left = 0;
                }
              }
            }
            if (find_line_left == 0)
            {
              xieshizi_rebreak_left = i+1;
              break;
            }
          }
        }
        if(xieshizi_youdiu_count==1)
        {
          if(xieshizi_find_right-xieshizi_break_right>=3)
          {
            xieshizi_you_restart=xieshizi_find_right-3;
          }
          else if(xieshizi_find_right-xieshizi_break_right<3&&xieshizi_find_right-xieshizi_break_right>=0)
          {
            xieshizi_you_restart=xieshizi_break_right;
          }
          xieshizi_rebreak_right=39;
          for (int i = xieshizi_you_restart; i >= 0; i--)
          {
            for (j = 0; j <= Tracking_NUM; j++) //  18
            {
              if (rightline[i + 1] + j -Interval- Tracking_displacement >= 0 &&rightline[i + 1] + j - Tracking_displacement< CAMERA_W)
              {
                if (imgbuff[i][rightline[i + 1] + j-Interval - Tracking_displacement] -imgbuff[i][rightline[i + 1] + j - Tracking_displacement ] >(Jump_threhold - 0.3 * (39 - i))&&imgbuff[i][rightline[i + 1] + j-Interval - Tracking_displacement]>150&&imgbuff[i][rightline[i + 1] + j - Tracking_displacement ]<150)       // gai imgbuff[i][rightline[i + 1] + j - Tracking_displacement -Interval] -imgbuff[i][rightline[i + 1] + j - Tracking_displacement] >(Jump_threhold - 0.3 * (39 - i))
                {
                  rightline[i] = rightline[i + 1] + j - Tracking_displacement;
                  find_line_right = 1;
                  xieshizi_rebreak_right = 0;
                  break;
                }
                else
                {
                  find_line_right = 0;
                }
              }
            }
            if (find_line_right == 0)
            {
              xieshizi_rebreak_right = i+1;
              break;
            }
          }              
        }
    
        
        //右线往后补线
        if(xieshizi_find_right-xieshizi_rebreak_right>=5)
        {
          slpoe_xieshizi_rightback=Least_Squares(&rightline[0],5,xieshizi_find_right);
          for(int i=xieshizi_find_right-2;i<=39;i++)
          {
            rightline[i] = rightline[xieshizi_find_right-2] - slpoe_xieshizi_rightback * (xieshizi_find_right-2 - i)/10;   
          }
        }
        else  if(xieshizi_find_right-xieshizi_rebreak_right>0&&xieshizi_find_right-xieshizi_rebreak_right<5)
        {
          slpoe_xieshizi_rightback=Least_Squares(&rightline[0],xieshizi_find_right-xieshizi_rebreak_right+1,xieshizi_find_right);
          for(int i=xieshizi_find_right;i<=39;i++)
          {
            rightline[i] = rightline[xieshizi_find_right] - slpoe_xieshizi_rightback * (xieshizi_find_right - i)/10;
          }
        }
        //右线往前补线
        
        if(xieshizi_find_right-xieshizi_rebreak_right>=5)
        {
          slpoe_xieshizi_rightfront=Least_Squares(&rightline[0],5,xieshizi_rebreak_right+4);
          for(int i=xieshizi_rebreak_right+2;i>=0;i--)
          {
            rightline[i] = rightline[xieshizi_rebreak_right+2] - slpoe_xieshizi_rightfront * (xieshizi_rebreak_right+2 - i)/10;
          }
        }
        else  if (xieshizi_find_right-xieshizi_rebreak_right>0&&xieshizi_find_right-xieshizi_rebreak_right<5)
        {
          slpoe_xieshizi_rightfront=Least_Squares(&rightline[0],xieshizi_find_right-xieshizi_rebreak_right+1,xieshizi_find_right);
          for(int i=xieshizi_rebreak_right;i>=0;i--)
          {
            rightline[i] = rightline[xieshizi_rebreak_right] - slpoe_xieshizi_rightfront * (xieshizi_rebreak_right- i)/10;
          }
        }
        
        //左线补线
        if(xieshizi_zuodiu_count==1)
        {
          if(xieshizi_find_left-xieshizi_rebreak_left>=5)
          {
            slpoe_xieshizi_leftback=Least_Squares(&leftline[0],5,xieshizi_find_left);
            for(int i=xieshizi_find_left-2;i<=39;i++)
            {
              leftline[i] = leftline[xieshizi_find_left-2] -slpoe_xieshizi_leftback * (xieshizi_find_left-2 - i)/10;
            }
            slpoe_xieshizi_leftfront=Least_Squares(&leftline[0],5,xieshizi_rebreak_left+4);
            for(int i=xieshizi_rebreak_left+2;i>=0;i--)
            {
              leftline[i] = leftline[xieshizi_rebreak_left+2] -slpoe_xieshizi_leftfront * (xieshizi_rebreak_left+2 - i)/10;
            }
          }
          else
          {
            for(int i=39;i>=0;i--)
            {
              leftline[i]=rightline[i]-width[i];   
            }
          }
        }
        else if(xieshizi_zuodiu_count==0)
        {
          for(int i=39;i>=0;i--)
          {
            leftline[i]=rightline[i]-width[i];   
          }
        }
      }
      
      //***出环形弯判断*******//
      if(ruhuandao_flag==1)
      {
        distance1=(speed_left+speed_right)/2+distance1;           
      }       
      chuhuan_lie=0;
      chuhuan_hang=0;
      count_white=0;
      white_flag=0;     
      
      //*******左转出环岛*******//
      if(leftline_flag==1&& (break_left>20||break_right>20)&&ruhuandao_flag==1 &&huandao[huandao_count]==1&&chuhuandao_flag!=2&& distance1>=1100) ///////////////////
      {
        chuhuandao_flag=0;
        for(i=CAMERA_R_H-3;i>break_left+3;i--)                           
        {
          if(leftline[i]>=leftline[i+1] && leftline[i]>=leftline[i-1] && leftline[i+1]>=leftline[i+2] && leftline[i-1]>=leftline[i-2])
          {
            tiaobian_left=i;
            break;
          }
        }
        
        if(tiaobian_left>=6 && leftline[tiaobian_left]>10)
        {
          for(int i=leftline[tiaobian_left]-10;i<=leftline[tiaobian_left]+10;i++)
          {
            if(imgbuff[tiaobian_left-5][i]>150)
            {
              count_white++;
            }
            if(count_white>=18)
            {
              white_flag=1;
              break;
            }
          }
        }
        
        if(tiaobian_left!=0&&white_flag==1)           
        { 
          if(leftline[tiaobian_left]>=99)
          {
            leftline[tiaobian_left]=99;       //防止数组溢出
          }
          for(int k=leftline[tiaobian_left];k<=leftline[tiaobian_left]+100;k++)
          {
            for(i=tiaobian_left-5;i>=15;i--)
            {
              if(imgbuff[i][k]-imgbuff[i-3][k]>Jump_threhold)
              {
                chuhuan_lie=k;
                chuhuan_hang=i-3;
                break;
              }
            }
            if(chuhuan_lie!=0&&chuhuan_hang!=0)
            {
              chuhuandao_flag=2;
              ruhuandao_flag=0;
              break;
            }
          }  
        }
      }
      
      //***********环形弯底行丢线*************//
      else if(leftline_flag==0&&  ruhuandao_flag==1 &&huandao[huandao_count]==1&&chuhuandao_flag!=2&& distance1>=1100 ) ///////////////  
      {
        huandao_diu_count=0;
        huandao_find_right=0;
        
        for(i=CAMERA_R_H-3;i>=0;i--)  
        {
          for(j=CAMERA_W/2;j>=4;j--)
          {
            if(imgbuff[i][j]-imgbuff[i][j-3]>Jump_threhold && imgbuff[i][j]-imgbuff[i][j-4]>Jump_threhold  )
            {
              huandao_diu_count++;
              if(huandao_diu_count==1)
              {
                huandao_find_left = i;
              }
              leftline[i]=j-3;     
              break;
            }
          } 
          
          if(i<huandao_find_left-4)
          {
            if(leftline[i+2]>=leftline[i] && leftline[i+2]>=leftline[i+1] && leftline[i+2]>=leftline[i+3] && leftline[i+2]>=leftline[i+4])
            {
              tiaobian_left=i+2;
              break;
            }
          }
        } 
        if(tiaobian_left>=6 && leftline[tiaobian_left]>10)
        {
          for(int i=leftline[tiaobian_left]-10;i<=leftline[tiaobian_left]+10;i++)
          {
            if(imgbuff[tiaobian_left-5][i]>150)
            {
              count_white++;
            }
            if(count_white>=18)
            {
              white_flag=1;
              break;
            }
          }
        }
        
        if(tiaobian_left!=0&&white_flag==1)//&& ruhuandao_flag!=1)                 
        { 
          if(leftline[tiaobian_left]>=99)
          {
            leftline[tiaobian_left]=99;       //防止数组溢出
          }
          for(int k=leftline[tiaobian_left];k<=leftline[tiaobian_left]+100;k++)
          {
            for(i=tiaobian_left-5;i>=15;i--)
            {
              if(imgbuff[i][k]-imgbuff[i-3][k]>Jump_threhold)
              {
                chuhuan_lie=k;
                chuhuan_hang=i-3;
                break;
              }
            }
            if(chuhuan_lie!=0&&chuhuan_hang!=0)
            {
              chuhuandao_flag=2;
              ruhuandao_flag=0;      //////////////////////////////////////sacacsac
              break;
            }
          }   
        }   
      }
      
      //*******右转出环岛*******//
      if(rightline_flag==1&& (break_left>20||break_right>20)&& ruhuandao_flag==1&&huandao[huandao_count]==0&&chuhuandao_flag!=2 && distance1>=1000)    //////////////// 
      {
         chuhuandao_flag=0;
        for(i=CAMERA_R_H-3;i>=break_right+3;i--)       ///改动了+3                               //寻找右边的跳变点
        {
          if(rightline[i]<=rightline[i+1] && rightline[i]<=rightline[i-1] && rightline[i+1]<=rightline[i+2] && rightline[i-1]<=rightline[i-2])
          {
            tiaobian_right=i;
            break;
          }
        }
        
        if(tiaobian_right>=6 && rightline[tiaobian_right]<CAMERA_W-10)
        {
          for(int i=rightline[tiaobian_right]-10;i<=rightline[tiaobian_right]+10;i++)
          {
            if(imgbuff[tiaobian_right-5][i]>150)
            {
              count_white++;
            }
            if(count_white>=18)
            {
              white_flag=1;
              break;
            }
          }
        }
        
        if(tiaobian_right!=0&&white_flag==1)//&& ruhuandao_flag!=1)                 
        { 
          if(rightline[tiaobian_right]-100<=0)
          {
            rightline[tiaobian_right]=100;       //防止数组溢出
          }
          
          for(int k=rightline[tiaobian_right];k>=rightline[tiaobian_right]-100;k--)
          {
            for(i=tiaobian_right-5;i>=15;i--)
            {
              if(imgbuff[i][k]-imgbuff[i-3][k]>Jump_threhold)
              {
                chuhuan_lie=k;
                chuhuan_hang=i-3;
                break;
              }
            }
            if(chuhuan_lie!=0&&chuhuan_hang!=0)
            {
              chuhuandao_flag=2;
              ruhuandao_flag=0;
              break;
            }
          }  
        }
      }
      
      //***********环形弯底行丢线*************//
      else if(rightline_flag==0&& ruhuandao_flag==1 &&huandao[huandao_count]==0&&chuhuandao_flag!=2&&distance1>=1000) ///////////////////////
      {
        huandao_diu_count=0;
        huandao_find_right=0;
        for(i=CAMERA_R_H-3;i>=0;i--)  
        {
          for(j=CAMERA_W/2;j<=CAMERA_W-5;j++)
          {
            if(imgbuff[i][j]-imgbuff[i][j+3]>Jump_threhold && imgbuff[i][j]-imgbuff[i][j+4]>Jump_threhold  )
            {
              huandao_diu_count++;
              if(huandao_diu_count==1)
              {
                huandao_find_right = i;
              }
              rightline[i]=j+3;
              break;
            }
          } 
          
          if(i<huandao_find_right-4)
          {
            if(rightline[i+2]<=rightline[i] && rightline[i+2]<=rightline[i+1] && rightline[i+2]<=rightline[i+3] && rightline[i+2]<=rightline[i+4])
            {
              tiaobian_right=i+2;
              break;
            }
          }
        } 
        if(tiaobian_right>=6 && rightline[tiaobian_right]<CAMERA_W-10)
        {
          for(int i=rightline[tiaobian_right]-10;i<=rightline[tiaobian_right]+10;i++)
          {
            if(imgbuff[tiaobian_right-5][i]>150)
            {
              count_white++;
            }
            if(count_white>=18)
            {
              white_flag=1;
              break;
            }
          }
        }
        
        if(tiaobian_right!=0&&white_flag==1)//&& ruhuandao_flag!=1)                 
        { 
          if(rightline[tiaobian_right]-100<=0)
          {
            rightline[tiaobian_right]=100;       //防止数组溢出
          }
          for(int k=rightline[tiaobian_right];k>=rightline[tiaobian_right]-100;k--)
          {
            for(i=tiaobian_right-5;i>=15;i--)
            {
              if(imgbuff[i][k]-imgbuff[i-3][k]>Jump_threhold)
              {
                chuhuan_lie=k;
                chuhuan_hang=i-3;
                break;
              }
            }
            if(chuhuan_lie!=0&&chuhuan_hang!=0)
            {
              chuhuandao_flag=2;
              ruhuandao_flag=0;
              break;
            }
          }  
        }
      }
      
      //***********环形弯道内补线*************//
      if(chuhuandao_flag==0)
      {
        if(break_right<=30 && break_right!=0)
        {
          slope=Least_Squares(&rightline[0],CAMERA_R_H-break_right,CAMERA_R_H-1);
          for(i=break_right+5;i>=0;i--)
          {
            rightline[i]=-slope*(break_right-i+5)/10+rightline[break_right+5];
          }         
        }
        
        if(break_left<=30 && break_left!=0)
        {
          slope=Least_Squares(&leftline[0],CAMERA_R_H-break_left,CAMERA_R_H-1);
          for(i=break_left+5;i>=0;i--)
          {
            leftline[i]=-slope*(break_left-i+5)/10+leftline[break_left+5];
          }       
        }
        if(leftline_flag==1 && break_left<=30 && break_right>30)
        {
          for(i=break_right;i>=0;i--)
          {
            rightline[i]=leftline[i]+kuandu[i];
          }
        }
        if(rightline_flag==1 && break_right<=30 && break_left>30)
        {
          for(i=break_left;i>=0;i--)
          {
            leftline[i]=rightline[i]-kuandu[i];
          }
        }
      }
      
      //***********前车环岛出口停车准备超车*************//  
      if(chuhuandao_flag==2&&former_flag==1&& cruise_mode_on == 0&&huandao_chaoche_set[huandao_count]==1)
      {  
        if(avg_distance>10&&avg_distance<=3000)
        {
          diushi_count=0;
          diushi_time=0;
//          former_flag=0;         
//          send_num=1;
          chuhuandao_ceju_flag=1;
          if(avg_distance>=600&&avg_distance<=3000)
          {
            speed=speedset_st;
          }
        }
        else 
        {
          chuhuandao_ceju_flag=0;
          speed_set=0;
          speed=0;
          diushi_count++;
          if(diushi_count>100)
          {
            diushi_time=diushi_time+1;
            diushi_count=0;
          }
          if(diushi_time>2)
          {
            //gg_flag=1;
            speed=speedset_st;           
            //cruise_mode_on=1;
          }
        }
      }      
      //***********出环形弯道补线*************//
      if(chuhuandao_flag==2&&huandao[huandao_count]==1)
      {          
        distance3=(speed_left+speed_right)/2+distance3;    
        distance1=0;  
        if(huandao_size_set[huandao_count]!=3||(huandao_size_set[huandao_count]==3&&distance3<=900))
        {
          if(break_right>=30&&break_right<=36)
          {
            slope_you_judge=Least_Squares(&rightline[0],CAMERA_R_H-break_right,CAMERA_R_H-1);
          }
          else if(break_right<30)
          {
            slope_you_judge=Least_Squares(&rightline[0],6,break_right+5);
          }
          if(leftline_flag!=0)
          {
            if(break_left<=37)
            {
              slope_chuhuan_zuo=Least_Squares(&leftline[0],CAMERA_R_H-break_left,CAMERA_R_H-1);
              if(slope_chuhuan_zuo<=3)
              {
                slope_chuhuan_zuo=5;  //5
              }
              for(i=break_left+2;i>=0;i--)          
              {
                leftline[i]=-slope_chuhuan_zuo*(break_left-i+2)/10+leftline[break_left+2];  
              }
            } 
            switch(huandao_size_set[huandao_count])
            {
            case 1:
              change_num=20; 
              break;
            case 2:
              change_num=40; 
              break; 
            case 3:
              change_num=40; 
              break; 
            }          
            if(rightline_flag==0)
            {
              for(i=0;i<=CAMERA_R_H-1;i++)
              {   
                rightline[i]=leftline[i]+width[i]+change_num;    /////////左边出环以左边线跑
              }
            }          
            else  if(slope_you_judge<=0&&rightline_flag!=0)
            {
              for(i=0;i<=CAMERA_R_H-1;i++)
              {   
                rightline[i]=leftline[i]+width[i]+change_num;    /////////左边出环以左边线跑
              }
            }
          }
          else  
          {
            chuhuan_diu_count=0;
            for(i=CAMERA_R_H-3;i>=0;i--)  
            {
              for(j= midline[Last_line];j>=4;j--)
              {
                if(imgbuff[i][j]-imgbuff[i][j-3]>Jump_threhold && imgbuff[i][j]-imgbuff[i][j-4]>Jump_threhold&&imgbuff[i][j]>150&&imgbuff[i][j-3]<150  )
                {
                  if(chuhuan_diu_count==0)
                  {
                    chuhuan_diu_count++;
                    if(chuhuan_diu_count==1)
                    {
                      chuhuan_find_left = i;
                    }
                  }
                  leftline[i]=j-3; 
                  break_left=0;
                  find_line_left=1;
                  break;
                }
                else
                {
                  find_line_left = 0;
                }
              } 
              if(find_line_left==0&&chuhuan_diu_count==1)
              {
                break_left=i+1;
                break;
              }
            } 
            if(chuhuan_find_left-break_left>=3)
            {
              slope_chuhuan_zuo=Least_Squares(&leftline[0],4,break_left+3);
              //            if(slope_chuhuan_zuo<=3&&slope_chuhuan_zuo>=-25)
              //            {
              //              slope_chuhuan_zuo=5;
              //            }
              if(slope_chuhuan_zuo>=0)
              {
                for(i=break_left+2;i>=0;i--)           
                {
                  leftline[i]=-slope_chuhuan_zuo*(break_left-i+2)/10+leftline[break_left+2];  
                }
                if(slope_you_judge<=0)
                {
                  for(int i=Last_line;i>=0;i--)
                  {
                    rightline[i]=leftline[i]+width[i];
                  }
                }
              }
              if(slope_chuhuan_zuo<0)
              {
                for(int i=CAMERA_R_H-1;i>=3;i--)
                {
                  if(imgbuff[i][5]-imgbuff[i-3][5]>Jump_threhold)
                  {
                    chuhuan_hang=i-3;
                    break;
                  }
                }
                slope_chuhuan=150/(38-chuhuan_hang);
                if(slope_chuhuan>=9||slope_chuhuan<=7)
                {
                  slope_chuhuan=9;
                }
                for(int i=CAMERA_R_H-1;i>=0;i--)
                {
                  rightline[i]=199-slope_chuhuan*(CAMERA_R_H-1-i);
                  leftline[i]=rightline[i]-width[i];
                }      
              }
            }   
            //          if(rightline_flag==0)
            //          {
            //            for(i=0;i<=CAMERA_R_H-1;i++)
            //            {   
            //              rightline[i]=leftline[i]+width[i]+20;    /////////左边出环以左边线跑
            //            }
            //          }
            //          else  if(slope_you_judge<=0&&rightline_flag!=0)
            //          {
            //            for(i=0;i<=CAMERA_R_H-1;i++)
            //            {   
            //              rightline[i]=leftline[i]+width[i]+20;    /////////左边出环以左边线跑
            //            }
            //          }
            //          else if (slope_you_judge>0&&rightline_flag!=0)
            //          {
            //            for(i=0;i<=CAMERA_R_H-1;i++)
            //            {   
            //              leftline[i]=rightline[i]-width[i];    /////////左边出环以左边线跑
            //            }
            //          }
            else if((rightline_flag!=0&&slope_you_judge<=0)||rightline_flag==0)
            {
              for(int i=CAMERA_R_H-1;i>=3;i--)
              {
                if(imgbuff[i][5]-imgbuff[i-3][5]>Jump_threhold)
                {
                  chuhuan_hang=i-3;
                  break;
                }
              }
              slope_chuhuan=150/(38-chuhuan_hang);
              if(slope_chuhuan>=9||slope_chuhuan<=7)
              {
                slope_chuhuan=9;
              }
              for(int i=CAMERA_R_H-1;i>=0;i--)
              {
                rightline[i]=199-slope_chuhuan*(CAMERA_R_H-1-i);
                leftline[i]=rightline[i]-width[i];
              }             
            }
            if(rightline_flag!=0&&slope_chuhuan_zuo>0)
            {
              for(i=0;i<=CAMERA_R_H-1;i++)
              {
                leftline[i]=rightline[i]-width[i];
              }
            }
          }
        } 
        if(huandao_size_set[huandao_count]==3&&distance3>900)
        {
          if(leftline_flag!=0&&rightline_flag==0)
          {
            slope=Least_Squares(&leftline[0],CAMERA_R_H-break_left,CAMERA_R_H-1);
            for(i=break_left+4;i>=0;i--)  
            {
              leftline[i]=-slope*(break_left-i+4)/10+leftline[break_left+4]; 
            }
            for(int i=Last_line;i>=0;i--)
            {
              rightline[i]=leftline[i]+width[i];
            }
          }
          if(leftline_flag==0&&rightline_flag!=0)
          {
            slope=Least_Squares(&rightline[0],CAMERA_R_H-break_right,CAMERA_R_H-1);
            for(i=break_right+4;i>=0;i--)  
            {
              rightline[i]=-slope*(break_right-i+4)/10+rightline[break_right+4]; 
            } 
            for(int i=Last_line;i>=0;i--)
            {
              leftline[i]= rightline[i]-width[i];
            }
          } 
          if(leftline_flag!=0&&rightline_flag!=0)
          {
            if(break_right<=30 && break_right!=0)
            {
              slope=Least_Squares(&rightline[0],CAMERA_R_H-break_right,CAMERA_R_H-1);
              for(i=break_right+5;i>=0;i--)  
              {
                rightline[i]=-slope*(break_right-i+5)/10+rightline[break_right+5];
              }  
            }
            
            if(break_left<=30 && break_left!=0)
            {
              slope=Least_Squares(&leftline[0],CAMERA_R_H-break_left,CAMERA_R_H-1);
              for(i=break_left+5;i>=0;i--)  
              {
                leftline[i]=-slope*(break_left-i+5)/10+leftline[break_left+5];
              }
            }
          }
        }
        //*********//   
      }
      
      if(chuhuandao_flag==2&&huandao[huandao_count]==0)
      {        
        distance3=(speed_left+speed_right)/2+distance3;    
        distance1=0;
        if(huandao_size_set[huandao_count]!=3||(huandao_size_set[huandao_count]==3&&distance3<=900))
        {
          if(break_left>=30&&break_left<=36)
          {
            slope_zuo_judge=Least_Squares(&leftline[0],CAMERA_R_H-break_left,CAMERA_R_H-1);
          }
          else  if(break_left<30)
          {
            slope_zuo_judge=Least_Squares(&leftline[0],6,break_left+5);          
          }
          if(rightline_flag!=0)
          {
            if(break_right<=37)
            {
              slope_chuhuan_you=Least_Squares(&rightline[0],CAMERA_R_H-break_right,CAMERA_R_H-1);
              if(slope_chuhuan_you>=-3)
              {
                slope_chuhuan_you=-15;
              }
              for(i=break_right+2;i>=0;i--)       //    4
              {
                rightline[i]=-slope_chuhuan_you*(break_right-i+2)/10+rightline[break_right+2];  // 10
              }  
            }
            switch(huandao_size_set[huandao_count])
            {
            case 1:
              change_num=20; 
              break;
            case 2:
              change_num=40; 
              break; 
            case 3:
              change_num=40; 
              break; 
            }
            if(leftline_flag==0)
            {
              for(i=0;i<=CAMERA_R_H-1;i++)
              {
                leftline[i]=rightline[i]-width[i]-change_num;
              }
            }
            else if(leftline_flag!=0&&slope_zuo_judge>=0)
            {
              for(i=0;i<=CAMERA_R_H-1;i++)
              {
                leftline[i]=rightline[i]-width[i]-change_num;
              }
            }
          }  
          else
          { 
            chuhuan_diu_count=0;
            for(i=CAMERA_R_H-3;i>=0;i--)  
            {
              for(j=midline[39];j<=CAMERA_W-5;j++)
              {
                if(imgbuff[i][j]-imgbuff[i][j+3]>Jump_threhold && imgbuff[i][j]-imgbuff[i][j+4]>Jump_threhold &&imgbuff[i][j]>150&&imgbuff[i][j+3]<150 )
                {
                  if(chuhuan_diu_count==0)
                  {
                    chuhuan_diu_count++;
                    if(chuhuan_diu_count==1)
                    {
                      chuhuan_find_right = i;
                    }
                  }
                  rightline[i]=j+3; 
                  break_right=0;
                  find_line_right=1;
                  break;
                }
                else
                {
                  find_line_right = 0;
                }
              } 
              if(find_line_right==0&&chuhuan_diu_count==1)
              {
                break_right=i+1;
                break;
              }
            } 
            if(chuhuan_find_right-break_right>=3)
            {
              slope_chuhuan_you=Least_Squares(&rightline[0],4,break_right+3);
              if(slope_chuhuan_you<=0)
              {
                for(i=break_right+2;i>=0;i--)       
                {
                  rightline[i]=-slope_chuhuan_you*(break_right-i+2)/10+rightline[break_right+2];  
                }  
                if(slope_zuo_judge>=0)
                {
                  for(int i=Last_line;i>=0;i--)
                  {
                    leftline[i]=rightline[i]-width[i];
                  }
                }
              }
              if(slope_chuhuan_you>0) 
              {
                for(int i=CAMERA_R_H-1;i>=3;i--)
                {
                  if(imgbuff[i][190]-imgbuff[i-3][190]>Jump_threhold)
                  {
                    chuhuan_hang=i-3;
                    break;
                  }
                }
                slope_chuhuan=190/(38-chuhuan_hang);
                if(slope_chuhuan<=8||slope_chuhuan>=9)
                {
                  slope_chuhuan=8;
                }
                for(int i=CAMERA_R_H-1;i>=0;i--)
                {
                  leftline[i]=1+slope_chuhuan*(CAMERA_R_H-1-i);
                  rightline[i]=leftline[i]+width[i]+30;
                }               
              }
            }
            else  if((leftline_flag!=0&&slope_zuo_judge>=0)||leftline_flag==0)
            {
              for(int i=CAMERA_R_H-1;i>=3;i--)
              {
                if(imgbuff[i][190]-imgbuff[i-3][190]>Jump_threhold)
                {
                  chuhuan_hang=i-3;
                  break;
                }
              }
              slope_chuhuan=190/(38-chuhuan_hang);
              if(slope_chuhuan<=8||slope_chuhuan>=9)
              {
                slope_chuhuan=9;
              }
              for(int i=CAMERA_R_H-1;i>=0;i--)
              {
                leftline[i]=1+slope_chuhuan*(CAMERA_R_H-1-i);
                rightline[i]=leftline[i]+width[i]+30;
              }             
            }
            if(leftline_flag!=0&&slope_zuo_judge<0)
            {
              for(i=0;i<=CAMERA_R_H-1;i++)
              {
                rightline[i]=leftline[i]+width[i];
              }
            }         
          }
        }
        if(huandao_size_set[huandao_count]==3&&distance3>900)
        {
          if(leftline_flag!=0&&rightline_flag==0)
          {
            slope=Least_Squares(&leftline[0],CAMERA_R_H-break_left,CAMERA_R_H-1);
            for(i=break_left+4;i>=0;i--)  
            {
              leftline[i]=-slope*(break_left-i+4)/10+leftline[break_left+4]; 
            }
            for(int i=Last_line;i>=0;i--)
            {
              rightline[i]=leftline[i]+width[i];
            }
          }
          if(leftline_flag==0&&rightline_flag!=0)
          {
            slope=Least_Squares(&rightline[0],CAMERA_R_H-break_right,CAMERA_R_H-1);
            for(i=break_right+4;i>=0;i--)  
            {
              rightline[i]=-slope*(break_right-i+4)/10+rightline[break_right+4]; 
            } 
            for(int i=Last_line;i>=0;i--)
            {
              leftline[i]= rightline[i]-width[i];
            }
          } 
          if(leftline_flag!=0&&rightline_flag!=0)
          {
            if(break_right<=30 && break_right!=0)
            {
              slope=Least_Squares(&rightline[0],CAMERA_R_H-break_right,CAMERA_R_H-1);
              for(i=break_right+5;i>=0;i--)  
              {
                rightline[i]=-slope*(break_right-i+5)/10+rightline[break_right+5];
              }  
            }
            
            if(break_left<=30 && break_left!=0)
            {
              slope=Least_Squares(&leftline[0],CAMERA_R_H-break_left,CAMERA_R_H-1);
              for(i=break_left+5;i>=0;i--)  
              {
                leftline[i]=-slope*(break_left-i+5)/10+leftline[break_left+5];
              }
            }
          }
        }
        //        if(huandao_size==3&&distance3>900&&distance3<1500)
        //        {
        //          if(leftline_flag==0&&rightline_flag!=0)
        //          {
        //            for(int i=Last_line;i>=0;i--)
        //            {
        //              leftline[i]=rightline[i]-width[i];
        //            }
        //          }
        //          if(leftline_flag!=0&&rightline_flag==0)
        //          {
        //            for(int i=Last_line;i>=0;i--)
        //            {
        //              rightline[i]=leftline[i]+width[i];
        //            }
        //          }
        //        }
      }
      
      if(distance3>=1500)
      {
        chuhuandao_flag=1;    
        distance3=0; 
        white_flag=0;
        huandao_count++;
        huandao_size=0;
        chuhuandao_ceju_flag=0;
        diushi_time=0;
      }
      if(huandao_count>huandao_number)
      {
        huandao_count=huandao_number;
      }
      
      /*************************************************
      正常情况下的补线程序
      *************************************************/
      
//      /*****************前行斜率补线*******************/
      if(xierushizi_flag==0 &&chuhuandao_flag==1&&ruhuandao_flag==0&&shizi_count!=1&&shizi_count!=3)    //shizi_count!=1&&shizi_count!=3
      {           
        if(break_right<=30 && break_right!=0)
        {
          slope=Least_Squares(&rightline[0],CAMERA_R_H-break_right,CAMERA_R_H-1);
          for(i=break_right+5;i>=0;i--)  
          {
            rightline[i]=-slope*(break_right-i+5)/10+rightline[break_right+5];
          }  
        }
        
        if(break_left<=30 && break_left!=0)
        {
          slope=Least_Squares(&leftline[0],CAMERA_R_H-break_left,CAMERA_R_H-1);
          for(i=break_left+5;i>=0;i--)  
          {
            leftline[i]=-slope*(break_left-i+5)/10+leftline[break_left+5];
          }
        }
      }
      
      /*****************对左线参考点多进行补线*******************/
      if(xierushizi_flag==0 &&chuhuandao_flag==1&&ruhuandao_flag==0&&shizi_count!=1&&shizi_count!=3)       //&&shizi_count!=1&&shizi_count!=3
      {
        if(leftline_flag==1 && break_left<=30 && break_right>30)
        {
          slope=Least_Squares(&leftline[0],CAMERA_R_H-break_left,CAMERA_R_H-1);
          for(i=break_left+4;i>=0;i--)  
          {
            leftline[i]=-slope*(break_left-i+4)/10+leftline[break_left+4]; 
          }
          for(i=break_right;i>=0;i--)
          {
            rightline[i]=leftline[i]+kuandu[i];
          }
        }
        /*****************对右线参考点多进行补线*******************/  
        if(rightline_flag==1 && break_right<=30 && break_left>30)
        {
          slope=Least_Squares(&rightline[0],CAMERA_R_H-break_right,CAMERA_R_H-1);
          for(i=break_right+4;i>=0;i--)  
          {
            rightline[i]=-slope*(break_right-i+4)/10+rightline[break_right+4]; 
          }  
          for(i=break_left;i>=0;i--)
          {
            leftline[i]=rightline[i]-kuandu[i];   
          }
        }
      }
      
      /***************   赛道宽度计算    ***************/
      //      kuandu_sum=0;
      //      kuandu_avg=0;
      for(i=CAMERA_R_H-1;i>=0;i--)
      {
        if(rightline[i]<=leftline[i])
        {
          kuandu[i]=0;
        }
        else
        {
          kuandu[i]=rightline[i]-leftline[i];
        }
      }
      //      for(i=19;i>=0;i--)
      //      {
      //        kuandu_sum=kuandu_sum+kuandu[i];        
      //      }
      //      kuandu_avg=kuandu_sum/20;
      
      /*************************************************
      开始判断赛道类型    
      *************************************************/
      zhidao_flag = 0;
      long temp1 = 0;
      long temp2 = 0;
      for (i = CAMERA_R_H-1; i >= 0; i--)
      {
        left_cha[i]=(midline[Last_line]-width[i]/2)-leftline[i];
        right_cha[i]=(midline[Last_line]+width[i]/2)-rightline[i];
        mid_cha[i]=midline[Last_line]-(leftline[i]+rightline[i])/2;         //100???? midline_last??
        temp1=temp1+ mid_cha[i];   
      }
      avg_front=temp1/CAMERA_R_H;
      if(break_left>break_right)
      {
        valid_line=break_left;       //valid_line 有效行
      }    
      else
      {
        valid_line=break_right;
      }
      for(int i=valid_line;i<=CAMERA_R_H-1;i++)
      {
        temp2=temp2+abs(mid_cha[i]-avg_front);                      
      }
      fangcha= temp2/(CAMERA_R_H-valid_line);             
      fangcha_cha=fangcha-fangcha_old;    
      fangcha_old=fangcha;
      
      //******直道判断******//
      if(fangcha<=12&&xierushizi_flag==0 &&shizi_count!=1&&shizi_count!=3&&chuhuandao_flag==1&&ruhuandao_flag==0)//7  !!!!!!!!!!!!         shizi_flag_zhi==0 
      {
        //*****避障直道****//     
        if(valid_line<=15)
        {
          bizhang_zhidao_flag=1;
        }
        else
        {
          bizhang_zhidao_flag=0;
        }
        
        //*****超车直道****// 
        if(fangcha<=3)
        {
          if(valid_line==0)
          {
            chaoche_zhidao_flag=1;
          }
          else
          {
            chaoche_zhidao_flag=0;
          }
        }
        
        //*****坡道直道****// 
        if(fangcha<=8&&valid_line==0)
        {
          podao_zhidao_flag=1;
        }
        else
        {
          podao_zhidao_flag=0;
        }
      }
      else 
      {
        podao_zhidao_flag=0;
        bizhang_zhidao_flag=0;
        chaoche_zhidao_flag=0;
      }
      
      /*************************************************
      避障
      *************************************************/
      if(bizhang_zhidao_flag==1&&zhangaifind_you_flag==0&&zhangaifind_zuo_flag==0&&podao_flag==0&&stop_flag==0) //////////前车避障//&&stop_flag==0
      {
        zhangai_check();
      }
      if(zhangaifind_you_flag!=0||zhangaifind_zuo_flag!=0)
      { 
        zhangai_check();
        if(zhangaifind_you_flag==1 &&zhangai_start>=20)
        {
          za_slope=Least_Squares(&zhangai_line_you[0],zhangai_start-zhangai_break+1,zhangai_start);
          if(za_slope<=0||za_slope>=20)
          {
            za_slope=12;
          }
          for(i=zhangai_start;i>=0;i--)///障碍往前补线
          {
            rightline[i]=-(za_slope-6)*(zhangai_start-i)/10+zhangai_line_you[zhangai_start]-15;      // 10
          }
          for(i=zhangai_start-1;i<=CAMERA_R_H-1;i++)//障碍往后补线
          {
            rightline[i]=-(za_slope+15)*(zhangai_start-1-i)/10+zhangai_line_you[zhangai_start-1]-15;   // 10
          }
        }   
        if(zhangaifind_zuo_flag==1 && zhangai_start>=20)
        {
          za_slope=Least_Squares(&zhangai_line_zuo[0],zhangai_start-zhangai_break+1,zhangai_start);
          if(za_slope>=0||za_slope<-10)
          {
            za_slope=-4;
          }
          for(i=zhangai_start-1;i>=0;i--)///障碍往前补线
          {
            leftline[i]=-(za_slope+2)*(zhangai_start-1-i)/10+zhangai_line_zuo[zhangai_start-1]+15;        // 10
          }
          for(i=zhangai_start-2;i<=CAMERA_R_H-1;i++)//障碍往后补线
          {
            leftline[i]=-(za_slope-15)*(zhangai_start-2-i)/10+zhangai_line_zuo[zhangai_start-2]+15;     // 10
          }
        }   
      }  
      
      /*************************************************
      前车超车直道判断
      *************************************************/  
      if(chaoche_zhidao_flag==1&&zhangaifind_you_flag==0&&zhangaifind_zuo_flag==0&&former_flag==1)
      {
        tiaobian_left=0;
        tiaobian_right=0;
        aobian_left=0;
        aobian_right=0;
        for(i=CAMERA_R_H-3;i>=10;i--)      // break点>10？？？？？
        {
          if(leftline[i]>=leftline[i+1] && leftline[i]>=leftline[i-1] && leftline[i+1]>=leftline[i+2] && leftline[i-1]>=leftline[i-2])
          {
            tiaobian_left=i;
            break;
          }
          if(leftline[i]<=leftline[i+1] && leftline[i]<=leftline[i-1] && leftline[i+1]<=leftline[i+2] && leftline[i-1]<=leftline[i-2])
          {
            aobian_left=i;
            break; 
          }
        }
        for(i=CAMERA_R_H-3;i>=10;i--)       // break点>10？？？？？
        {
          if(rightline[i]<=rightline[i+1] && rightline[i]<=rightline[i-1] && rightline[i+1]<=rightline[i+2] && rightline[i-1]<=rightline[i-2])
          {
            tiaobian_right=i;
            break;
          }
          if(rightline[i]>=rightline[i+1] && rightline[i]>=rightline[i-1] && rightline[i+1]>=rightline[i+2] && rightline[i-1]>=rightline[i-2])
          {
            aobian_right=i;
            break;
          }
        }
        
        if(tiaobian_left==0&&tiaobian_right==0&&aobian_right==0&&aobian_left==0)
        {
          chaoche_ready_flag=1;         //  超完车清零
        }
        else                 //if(tiaobian_left!=0&&tiaobian_right!=0)
        {
          chaoche_ready_flag=0;
          xiaos_flag=1;
        }
      }
      else
      {
        chaoche_ready_flag=0;
        xiaos_flag=0;
      }
      
      // ********坡道判斷**********//
      // ****前车判斷****//
      //      if(podao_zhidao_flag==1&&kuandu_avg>90&&former_flag==1&&podao_count==0&&podao_flag==0&&stop_flag==0)
      //      {
      //        podao_flag=1;
      //        for(int i=Last_line-1;i>=3;i--)
      //        {
      //          if(imgbuff[i][midline[Last_line]]-imgbuff[i-3][midline[Last_line]]>Jump_threhold)
      //          {
      //            podao_flag=0; 
      //            break;
      //          }
      //        }          
      //      }
      //      if(podao_flag==1&&podao_count==0&&former_flag==1)
      //      {
      //        send_num=8;
      //        podao_distance=podao_distance+(speed_left+speed_right)/2;
      //        if(podao_distance>1000)
      //        {
      //          podao_distance=0;
      //          podao_count=1;  //上坡
      //        }
      //      }
      //      if(podao_count==1&&podao_zhidao_flag==1&&kuandu_avg>90&&former_flag==1)
      //      {
      //        podao_count=2;  
      //      }
      //      if(podao_count==2&&former_flag==1)
      //      {
      //        podao_distance=podao_distance+(speed_left+speed_right)/2;
      //        if(podao_distance>1000)
      //        {
      //          podao_distance=0;
      //          podao_count=0;  //上坡
      //          podao_flag=0;
      //        }
      //      }
      //      
      //      // ****后车判斷****//
      //      if(former_flag==0&&podao_ready_flag==1)
      //      {
      //        if(podao_zhidao_flag==1&&kuandu_avg>90&&podao_count==0&&podao_flag==0)
      //        {
      //          podao_flag=1;        
      //        }
      //        if(podao_flag==1&&podao_count==0)
      //        {
      //          podao_distance=podao_distance+(speed_left+speed_right)/2;
      //          if(podao_distance>1000)
      //          {
      //            podao_distance=0;
      //            podao_count=1;  //上坡
      //            podao_ready_flag=0;
      //          }
      //        }
      //      }
      //      if(podao_count==1&&podao_zhidao_flag==1&&kuandu_avg>90&&former_flag==0)
      //      {
      //        podao_count=2;  
      //      }
      //      if(podao_count==2&&former_flag==0)
      //      {
      //        podao_distance=podao_distance+(speed_left+speed_right)/2;
      //        if(podao_distance>1000)
      //        {
      //          podao_distance=0;
      //          podao_count=0;  //上坡
      //          podao_flag=0;
      //        }
      //      }
      
      //      /*************************************************
      //      后车接受超车
      //      *************************************************/   
      //      if(jieshouchaoche_flag==1) //接受超车
      //      {
      //        chaoche_check();
      //      }
      //      //    if(chaochefind_zuo_flag!=0)
      //      //    { 
      //      //      chaoche_check();
      //      //    }
      //      if(chaochefind_zuo_flag==1 &&chaoche_start>=20)
      //      {
      //        cc_slope=Least_Squares(&chaoche_line_zuo[0],chaoche_start-chaoche_break+1,chaoche_start);
      //        if(za_slope>=0||za_slope<-10)
      //        {
      //          za_slope=-4;
      //        }
      //        for(i=chaoche_start-1;i>=0;i--)///障碍往前补线
      //        {
      //          leftline[i]=-(cc_slope+2)*(chaoche_start-1-i)/10+chaoche_line_zuo[chaoche_start-1]+15;
      //        }
      //        for(i=chaoche_start-2;i<=CAMERA_R_H-1;i++)//障碍往后补线
      //        {
      //          leftline[i]=-(cc_slope-15)*(chaoche_start-2-i)/10+chaoche_line_zuo[chaoche_start-2]+15;
      //        }            
      //      }
      
      
      
      //            //******后车十字超车******//
      ////      if(shizi_chaoche_flag==1&&(shizi_count==1||shizi_count==3)&&former_flag==0)
      ////      {
      ////        temp = 0;
      ////        for (i = CAMERA_R_H - 1; i >= 19; i--)
      ////        {
      ////          temp = temp + weight[i - 19] * rightline[i];
      ////        }
      ////        zhongxian_front[0] = (temp / 210)-15;
      ////      }
      //      
      //
//      if(shizi_count==1&&rightline_flag==0&&former_flag==0)
//      {
//        jieshouchaoche_flag=1;
//      }
//      if(jieshouchaoche_flag==1) //接受超车
//      {
//        shizi_chaoche_check();
//      }
      //    if(chaochefind_zuo_flag!=0)
      //    { 
      //      chaoche_check();
      //    }
//      if(chaochefind_zuo_flag==1&&rightline_flag==0)
//      {
//        cc_slope=Least_Squares(&chaoche_line_zuo[0],chaoche_start-chaoche_break+1,chaoche_start);
//        if(za_slope>=0||za_slope<-10)
//        {
//          za_slope=-4;
//        }
//        for(i=chaoche_start-1;i>=0;i--)///障碍往前补线
//        {
//          leftline[i]=-(cc_slope+2)*(chaoche_start-1-i)/10+chaoche_line_zuo[chaoche_start-1]+15;
//        }
//        for(i=chaoche_start-2;i<=CAMERA_R_H-1;i++)//障碍往后补线
//        {
//          leftline[i]=-(cc_slope-15)*(chaoche_start-2-i)/10+chaoche_line_zuo[chaoche_start-2]+15;
//        }            
//      }
      
      
      
      /*************************************************
      前车准备超车停车
      //    *************************************************/ 
      if(turn_flag==0&&chaoche_ready_flag==1&&former_flag==1&&zhidao_chaoche_count<=zhidao_chaoche_num)
      {
        safe_distance=safe_distance+(speed_left+speed_right)/2;     
      }
      if(safe_distance>=10&&former_flag==1)
      {
        turn_flag=1;
        chaochesudu_flag=1;
      }
      
      /*************************************************
      开始计算前20行与后20行的偏差
      *************************************************/
      zhongxian_front[3] = zhongxian_front[2];
      zhongxian_front[2] = zhongxian_front[1];
      zhongxian_front[1] = zhongxian_front[0];
      
      long temp = 0;
      if(stop_flag==0)         //正常行驶状态
      {
        for (i = CAMERA_R_H - 2; i >= 19; i--)
        {
          temp = temp + weight[i - 19] * (leftline[i] + rightline[i]) / 2;
        }
        zhongxian_front[0] = temp / 210;
      }
      else if(stop_flag==1&&zhongdianzhangai_location==0&&bizhang_zhidao_flag==1)         //起跑线处无障碍状态
      {
        for (i = CAMERA_R_H - 2; i >= 19; i--)
        {
          temp = temp + weight[i - 19] * (leftline[i] + rightline[i]) / 2;
        }
        zhongxian_front[0] = temp / 210;
      } 
      else if(stop_flag==1&&zhongdianzhangai_location==1&&bizhang_zhidao_flag==1)         //起跑线处障碍在左边状态
      {
        for (i = CAMERA_R_H - 2; i >= 19; i--)
        {
          temp = temp + weight[i - 19] * rightline[i];
        }
        zhongxian_front[0] = (temp / 210)-25;    
      } 
      else if(stop_flag==1&&zhongdianzhangai_location==2&&bizhang_zhidao_flag==1)         //起跑线处障碍在右边状态
      {
        for (i = CAMERA_R_H - 2; i >= 19; i--)
        {
          temp = temp + weight[i - 19] * leftline[i];
        }
        zhongxian_front[0] = (temp / 210)+27;//15
      }    
      
      //******前车十字超车******//
      //      if((shizi_count==1||shizi_count==3)&&former_flag==1&&shizi_ready_flag==0&&shizi_chaoche_flag==0)
      //      {
      //        shizi_ready_flag=1;
      //      }
      //      if(shizi_ready_flag==1)
      //      {
      //        shizi_chaoche_distance=shizi_chaoche_distance+(speed_left+speed_right)/2;
      //      }
      ///////////////左边停车左转
//      if(shizi_chaoche_distance>=500)
//      {
//        shizi_chaoche_distance=0;
//        shizi_ready_flag=0;
//        if(shizi_chaoche_flag==0)
//        {
//          if(fangcha<10&&break_left_shizi<=5&&break_right_shizi<=5)
//          {
//            shizi_chaoche_flag=1;
//            //            send_num=
//          }
//          else
//          {
//            shizi_chaoche_flag=0;
//          }
//        }
//      }
//      if(shizi_chaoche_flag==1)
//      {      
//        if(shizi_hui_flag==0)
//        {
//          speed=first_slow_speed;
//          dajiao_distance=70;
//          midline_drift=30;
//          shizi_hui_distance=shizi_hui_distance+(speed_left+speed_right)/2;
//          /////////////////左边停车左转
//          if(shizi_hui_distance<=dajiao_distance*5)
//          {       
//            long temp=0;
//            for(i=CAMERA_R_H-2;i>=19;i--)
//            {      
//              temp=temp+weight[i-19]*(leftline[i]+40-midline_drift*shizi_hui_distance/(dajiao_distance*5));  //midline_drift  中线漂移
//            }
//            zhongxian_front[0]=temp/210; 
//          }
//          else if(shizi_hui_distance>dajiao_distance*5)
//          {      
//            shizi_hui_flag=1;
//          }
//        }     
//        if(shizi_hui_flag==1)
//        {  
//          shizi_tingche_flag=0;
//          speed=second_slow_speed;
//          shizi_front_distance=shizi_front_distance+(speed_left+speed_right)/2;      
//          if(shizi_front_distance>=1000)//800
//          {
//            shizi_hui_distance=0;             
//            shizi_front_distance=0;
//            shizi_tingche_flag=1;    
//            shizi_hui_flag=2;            
//          }
//        }
//        if(shizi_tingche_flag==1)
//        {
//          if(avg_distance>=800&&avg_distance<=2000)
//          {
//            speed=speedset_st;
//            former_flag=0;
//            send_num=1;
//            shizi_hui_flag=0;
//            shizi_chaoche_flag=0;
//            shizi_tingche_flag=0;
//          }
//          else
//          {              
//            speed_set=0; 
//            speed=0;
//          }      
//        }            
////      }
//      
//      //******后车十字超车******//
//      //      if(shizi_count==1&&rightline_flag==0)
//      //      {
//      //        jieshouchaoche_flag=1;
//      //      }
//      if(jieshouchaoche_flag==1)
//      {
//        //        if(rightline_flag==0)
//        //        {
//        //          temp = 0;
//        //          for (i = CAMERA_R_H - 2; i >= 19; i--)
//        //          {
//        //            temp = temp + weight[i - 19] * rightline[i];
//        //          }
//        //          zhongxian_front[0] = (temp / 210)-40;//15
//        //        }
//        if(rightline_flag==1)
//        {
//          chaoche_distance=(speed_left+speed_right)/2+chaoche_distance;
//          if(chaoche_distance<1200)
//          {
//            temp = 0;
//            for (i = CAMERA_R_H - 2; i >= 19; i--)
//            {
//              temp = temp + weight[i - 19] * rightline[i];
//            }
//            zhongxian_front[0] = (temp / 210)-20;//15
//          }
//          if(chaoche_distance>=1200&&chaoche_distance<2000)
//          {  
//            //            chaochefind_zuo_flag=0;
//            if(leftline_flag==0)
//            {
//              for (i = CAMERA_R_H - 1; i >= 19; i--)      
//              {
//                leftline[i]=rightline[i]-width[i]; 
//              }
//              temp = 0;
//              for (i = CAMERA_R_H - 2; i >= 19; i--)
//              {
//                temp = temp + weight[i - 19] * (leftline[i] + rightline[i]) / 2;
//              }
//              zhongxian_front[0] = temp / 210;
//            }
//          }
//          if(chaoche_distance>=2000)
//          {
//            chaoche_distance=0;
//            //            chaoche_flag=0;
//            jieshouchaoche_flag=0;        //解除超车信号
//            //            zhidao_chaoche_count++;
//          } 
//        }
//      }
//      
//      
//      
      
      /*************************************************
      避障测距
      *************************************************/
      if(zhangai_start>=28)
      {
        bizhang_flag=1;
      }
      if(bizhang_flag==1)
      {
        zhangai_distance=(speed_left+speed_right)/2+zhangai_distance;
      }
      if(zhangai_distance<1200 &&  bizhang_flag==1 && zhangaifind_zuo_flag==1)
      {
        temp = 0;
        for (i = CAMERA_R_H - 2; i >= 19; i--)
        {
          temp = temp + weight[i - 19] * rightline[i];
        }
        zhongxian_front[0] = (temp / 210)-30;//15
      }
      else if (zhangai_distance<1200 &&  bizhang_flag==1 && zhangaifind_you_flag==1)
      {
        temp = 0;
        for (i = CAMERA_R_H - 2; i >= 19; i--)
        {
          temp = temp + weight[i - 19] * leftline[i];
        }
        zhongxian_front[0] = (temp / 210)+30;//15
      }
      if(zhangai_distance>=1200&&zhangai_distance<2000)
      {  
        zhangaifind_zuo_flag=0;
        zhangaifind_you_flag=0;
        if(rightline_flag==0)
        {
          for (i = CAMERA_R_H - 1; i >= 19; i--)       
          {
            rightline[i]=leftline[i]+width[i];
          }
          long temp = 0;  
          for (i = CAMERA_R_H - 2; i >= 19; i--)
          {
            temp = temp + weight[i - 19] * (leftline[i] + rightline[i]) / 2;
          }
          zhongxian_front[0] = temp / 210;
        }
        if(leftline_flag==0)
        {
          for (i = CAMERA_R_H - 1; i >= 19; i--)       
          { 
            leftline[i]=rightline[i]-width[i]; 
          }
          long temp = 0;  
          for (i = CAMERA_R_H - 2; i >= 19; i--)
          {
            temp = temp + weight[i - 19] * (leftline[i] + rightline[i]) / 2;
          }
          zhongxian_front[0] = temp / 210;
        }
      }
      if(zhangai_distance>=2000)
      {
        zhangai_distance=0;
        bizhang_flag=0;
      }
      
      //      /*************************************************
      //      后车超车测距
      //      *************************************************/
      //      if(chaoche_start>=28)
      //      {
      //        chaoche_flag=1;
      //      }
      //      if(chaoche_flag==1)
      //      {
      //        chaoche_distance=(speed_left+speed_right)/2+chaoche_distance;
      //      }
      //      if(chaoche_distance<1200 &&  chaoche_flag==1 && chaochefind_zuo_flag==1)
      //      {
      //        temp = 0;
      //        for (i = CAMERA_R_H - 2; i >= 19; i--)
      //        {
      //          temp = temp + weight[i - 19] * rightline[i];
      //        }
      //        zhongxian_front[0] = (temp / 210)-15;//15
      //      }
      //      //    else if (zhangai_distance<1200 &&  bizhang_flag==1 && zhangaifind_you_flag==1)
      //      //    {
      //      //      temp = 0;
      //      //      for (i = CAMERA_R_H - 2; i >= 19; i--)
      //      //      {
      //      //        temp = temp + weight[i - 19] * leftline[i];
      //      //      }
      //      //      zhongxian_front[0] = (temp / 210)+30;//15
      //      //    }
      //      if(chaoche_distance>=1200&&chaoche_distance<2000)
      //      {  
      //        chaochefind_zuo_flag=0;
      //        //      zhangaifind_you_flag=0;
      //        //      if(rightline_flag==0)
      //        //      {
      //        //        for (i = CAMERA_R_H - 1; i >= 20; i--)
      //        //        {
      //        //          rightline[i]=leftline[i]+width[i];
      //        //        }
      //        //      }
      //        if(leftline_flag==0)
      //        {
      //          for (i = CAMERA_R_H - 1; i >= 19; i--)      
      //          {
      //            leftline[i]=rightline[i]-width[i]; 
      //          }
      //            temp = 0;
      //          for (i = CAMERA_R_H - 2; i >= 19; i--)
      //          {
      //            temp = temp + weight[i - 19] * (leftline[i] + rightline[i]) / 2;
      //          }
      //          zhongxian_front[0] = temp / 210;
      //        }
      //      }
      //      if(chaoche_distance>=2000)
      //      {
      //        chaoche_distance=0;
      //        chaoche_flag=0;
      //        jieshouchaoche_flag=0;        //解除超车信号
      //        zhidao_chaoche_count++;
      //      } 
      //           
      /*************************************************
      前车停车
      *************************************************/
      if(turn_flag==1&& hui_flag==0)
      {
        send_num=2;
        speed=first_slow_speed;
        dajiao_distance=100;
        midline_drift=70;
        chaoche_stop_distance=chaoche_stop_distance+(speed_left+speed_right)/2;
        /////////////////左边停车左转
        if(chaoche_stop_distance<=dajiao_distance*5)
        {       
          long temp=0;
          for(i=CAMERA_R_H-2;i>=19;i--)
          {      
            temp=temp+weight[i-19]*(leftline[i]+40-midline_drift*chaoche_stop_distance/(dajiao_distance*5));  //midline_drift  中线漂移
          }
          zhongxian_front[0]=temp/210; 
          Left_turn_flag=1;
        }
        else if(chaoche_stop_distance>dajiao_distance*5)
        {      
          hui_flag=1;
          Left_turn_flag=0;
        }
      }     
      if(hui_flag==1)
      {  
        tingche_chaoche_flag=0;
        speed=second_slow_speed;
        front_distance=front_distance+(speed_left+speed_right)/2;      
        if(front_distance>=700)//800
        {
          safe_distance=0;
          turn_flag=0;
          chaoche_stop_distance=0;             
          front_distance=0;
          tingche_chaoche_flag=1;    
          hui_flag=2;            
        }
      }
      if(tingche_chaoche_flag==1)
      {
        if(avg_distance>=800&&avg_distance<=2000)
        {
          speed=speedset_st;
          former_flag=0;
          send_num=1;
          hui_flag=0;
          chaochesudu_flag=0;
          tingche_chaoche_flag=0;
        }
        else
        {              
          speed_set=0; 
          speed=0;
        }      
      }
      
      //     前车停车打角度  
      //      
      //      
      //      //*******出赛道保护********//
      //      black=0;
      //      for(i=0;i<=CAMERA_W-1;i++)
      //      {
      //        if(imgbuff[CAMERA_R_H-1][i]<160)
      //        {
      //          black++;
      //        }
      //      }
      //      if(black>=CAMERA_W-2)
      //      {
      //        chusaidao_flag=1;
      //      }
      
      /**************     偏差计算      ***************/
      //      if(hui_flag==0)
      //      {
      //        error_steer[2] = error_steer[1];
      //        error_steer[1] = error_steer[0];
      //        error_steer[0] = 100 - zhongxian_front[0];
      //      }
      if(hui_flag==1||shizi_hui_flag==1)
      {
        error_steer[2] = error_steer[1];
        error_steer[1] = error_steer[0];
        error_steer[0] = 135 - zhongxian_front[0];    
      }  
      else
      {
        error_steer[2] = error_steer[1];
        error_steer[1] = error_steer[0];
        error_steer[0] = 100 - zhongxian_front[0];
      }
      
      
      //    error_steer[2] = error_steer[1];
      //    error_steer[1] = error_steer[0];
      //    error_steer[0] = 100 - zhongxian_front[0];
      //      /*****中线的平滑传递*****/
      //
      //              if(break_right==0 && break_left==0 && shizi_flag_zhi!=0 &&
      //              xierushizi_flag!=0)    //两边都未找到线，保持上一次的误差
      //              {
      //                error_steer[5]=error_steer[4];
      //                error_steer[4]=error_steer[3];
      //                error_steer[3]=error_steer[2];
      //                error_steer[2]=error_steer[1];
      //                error_steer[1]=error_steer[0];
      //              }
      //              else //正常情况下，进行参数的平滑传递
      //              {
      //                error_steer[5]=error_steer[4];7    //                error_steer[4]=error_steer[3];
      //                error_steer[3]=error_steer[2];
      //                error_steer[2]=error_steer[1];
      //                error_steer[1]=error_steer[0];
      //                error_steer[0]=100-zhongxian_front[0];
      //              }
      //
      //chasu();   
      
      //      if (zhangaifind_you_flag==1||zhangaifind_zuo_flag==1||chaochefind_zuo_flag)
      //      {
      //        steer_out = steer_mid + steer_wan_kp_left * error_steer[0] +
      //          steer_wan_kd_left * (error_steer[0] - error_steer[1]);
      //      }
      //      else if (bizhang_zhidao_flag == 1&& xiaos_flag==0 )
      //      {
      //        steer_out = steer_mid + steer_zhi_kp * error_steer[0] +
      //          steer_zhi_kd * (error_steer[0] - error_steer[1]);
      //      }
      //      else if(xiaos_flag == 1)
      //      {
      //        steer_out = steer_mid + steer_xiaos_kp * error_steer[0] +
      //          steer_xiaos_kd * (error_steer[0] - error_steer[1]);
      //      }
      //       else if(chuhuandao_flag==0&&ruhuandao_flag==1)//(chuhuandao_flag==0&&ruhuandao_flag==1)
      //      {
      //        steer_out = steer_mid + steer_mid_huandao_kp * error_steer[0] +
      //          steer_mid_huandao_kd * (error_steer[0] - error_steer[1]);
      //      }
      //         else if(chuhuandao_flag==2&&ruhuandao_flag==0)//(chuhuandao_flag==2&&ruhuandao_flag==0)
      //      {
      //        steer_out = steer_mid + steer_exit_huandao_kp * error_steer[0] +
      //          steer_exit_huandao_kd * (error_steer[0] - error_steer[1]);
      //      }
      //      else  if(chaochesudu_flag==1)
      //      {
      //        steer_out = steer_mid + 0.9 * error_steer[0] + 2.1* (error_steer[0] - error_steer[1]);          
      //      }
      //      else
      //      {
//      if (error_steer[0] >= 0)
//      {
//        steer_out = steer_mid + steer_wan_kp_left * error_steer[0] +
//          steer_wan_kd_left * (error_steer[0] - error_steer[1]);
//      }
//      else
//      {
//        steer_out = steer_mid + steer_wan_kp_right * error_steer[0] +
//          steer_wan_kd_right * (error_steer[0] - error_steer[1]);
//      }
      // }
      
      error_piancha=error_steer[0]-error_steer[1];         // 偏差率
      
      error_I+=error_steer[0];
      if (error_I>= 1000)
      {
	error_I = 1000;
      }
      if (error_I <= -1000)
      {
	error_I = -1000;
      }
      
      Fuzzy_Scan(error_steer[0]);
      
      steer_out = steer_mid + DIRC_P * error_steer[0] +
	DIRC_D * (error_steer[0] - error_steer[1]);//+DIRC_I*error_I;DIRC_D
    }
    
    if (steer_out >= steer_left_max)
    {
      steer_out = steer_left_max;
    }
    if (steer_out <= steer_right_max)
    {
      steer_out = steer_right_max;
    }  
    FTM_PWM_Duty(FTM1, FTM_CH0, steer_out);
    
    
    /**********    串口发送    **************/ ///
    if(send_img_on)
    {    
      uart_putchar(UART4,0xff);
      for(int j = 0;j<CAMERA_R_H;j++)
      {
        for(int i = 0;i<CAMERA_W;i++)
        {
          if(imgbuff[j][i]==0xff)
          {
            imgbuff[j][i]=0xfe;
          }
          if(rightline[j]==i)
          {
            imgbuff[j][rightline[j]]=0;
          }
          if(leftline[j]==i)
          {
            imgbuff[j][leftline[j]]=0;
          }
          uart_putchar(UART4,imgbuff[j][i]);
        }
      }
    }
    
    
    
    
        LCD_Show_Number(50, 1, huandao_size_set[huandao_count]);    
        LCD_Show_Number(50, 2, chuhuandao_flag);  
        LCD_Show_Number(50, 3, distance3); 
//        LCD_Show_Number(50, 4, distance3);    
//    LCD_Show_Number(50, 1, shizi_flag_zhi);
//    LCD_Show_Number(20,2, ruhuandao_flag);
//    LCD_Show_Number(80, 2, chuhuandao_flag);
//    LCD_Show_Number(50, 4, xierushizi_flag);
//    LCD_Show_Number(50, 5, huandao_size);
//    LCD_Show_Number(50, 6, change_num);
    //    LCD_Show_Number(20, 3, jieshouchaoche_flag);
    //    LCD_Show_Number(80, 1, rightline_flag);
    //    LCD_Show_Number(20, 4, shizi_chaoche_distance);   
    //    LCD_Show_Number(80, 4, shizi_front_distance);
    //    LCD_Show_Number(50, 6, shizi_tingche_flag);
    //    LCD_Show_Number(80, 6, break_right_shizi);
    //    LCD_Show_Number(50, 6, chaoche_distance);
    
    
    if(ruhuandao_flag==1)     //shizi_count==1||shizi_count==3
    {
      gpio_set (PTD8,0);
    }
    else
    {
      gpio_set (PTD8,1);
    }
  }           
}
/****************************************************
障碍判断
***************************************************/
void zhangai_check(void)
{
  zhangai_right_flag = 0;
  zhangai_left_flag = 0;
  zhangai_start = 0;
  zhangai_start_you=0;
  zhangai_start_zuo=0;  
  zhangaifind_flag=0;
  zhangai_start=0;
  count=0;
  slope_zhangai_you=0;
  slope_zhangai_zuo=0;
  zhangai_break=0;
  for (int i = 39; i >= 0; i--)
  {
    zhangai_line_zuo[i] = 0;
    zhangai_line_you[i] = 0;
  }
  
  for (int i = 39; i >= 15; i--)//15
  {
    for (j = (leftline[i]+rightline[i])*0.5; j <= rightline[i]-width[i]/3; j++)     
    {
      if ((imgbuff[i][j] - imgbuff[i][j+3] > Jump_threhold) && (imgbuff[i][j]-imgbuff[i][j+4]>Jump_threhold )&& (imgbuff[i][j]-imgbuff[i][j+6]>Jump_threhold )&& (imgbuff[i][j]-imgbuff[i][j+9]>Jump_threhold )&& (imgbuff[i][j]-imgbuff[i][j+12]>Jump_threhold )&& (imgbuff[i][j]-imgbuff[i][j+15]>Jump_threhold )&&imgbuff[i][j]>150&&imgbuff[i][j+3]<150&&imgbuff[i][j+4]<150&&imgbuff[i][j+6]<150&&imgbuff[i][j+9]<150&&imgbuff[i][j+12]<150&&imgbuff[i][j+15]<150)
      {
        count++;
        zhangai_line_you[i] = j + 3;
        break;
      }
    }
    if(count==3)
    {
      count=0;
      zhangai_start_you = i+2;
      break;
    }
  }
  
  if(zhangai_start_you==0)
  {
    count=0;
    for (int i = 39; i >= 15; i--)//15
    {
      for (j = (leftline[i]+rightline[i])*0.5; j >= leftline[i]+width[i]/3; j--)     ///往左边扫障碍跳变   5-14改width[i]/3
      {
        if ((imgbuff[i][j] - imgbuff[i][j -3] >Jump_threhold) && (imgbuff[i][j] - imgbuff[i][j -4] >Jump_threhold)&&(imgbuff[i][j] - imgbuff[i][j -6] >Jump_threhold)&&(imgbuff[i][j] - imgbuff[i][j -9] >Jump_threhold)&&(imgbuff[i][j] - imgbuff[i][j -12] >Jump_threhold)&&(imgbuff[i][j] - imgbuff[i][j -15] >Jump_threhold)&&imgbuff[i][j]>150&&imgbuff[i][j-3]<150&&imgbuff[i][j-4]<150&&imgbuff[i][j-6]<150&&imgbuff[i][j-9]<150&&imgbuff[i][j-12]<150&&imgbuff[i][j-15]<150)
        {
          count++;
          zhangai_line_zuo[i] = j - 3;
          break;
        }
      }
      if(count==3)
      {
        count=0;
        zhangai_start_zuo = i+2;
        break;
      }
    }
  }
  
  if(zhangai_start_zuo==0&&zhangai_start_you!=0)
  {
    zhangai_start=zhangai_start_you;
    zhangai_right_flag = 1;
    zhangai_left_flag = 0;
  }
  else if(zhangai_start_zuo!=0&&zhangai_start_you==0)
  {
    zhangai_start=zhangai_start_zuo;
    zhangai_left_flag = 1;
    zhangai_right_flag = 0;
  }
//  else if(zhangai_start_zuo!=0&&zhangai_start_you!=0)
//  {
//    zhangai_start=0;
//    zhangai_start_zuo=0;
//    zhangai_start_you=0;
//    zhangai_left_flag = 0;
//    zhangai_right_flag = 0;
//    zhangaifind_you_flag=0;
//    zhangaifind_zuo_flag=0;
//  }
  
  if (zhangai_start!= 0)
  {
    if (zhangai_right_flag==1)
    { 
      for(int i = zhangai_start - 3; i >= zhangai_start - 12; i--)        //  ！！！！！！改(int i = zhangai_start - 3; i >= zhangai_start - 13; i--)
      {
        for (int j = zhangai_line_you[i + 1] - 10; j <= zhangai_line_you[i + 1] + 10; j++)//int j = zhangai_line_you[i + 1] - 10; j <= zhangai_line_you[i + 1] + 10; j++
        {       
          if ((imgbuff[i][j] - imgbuff[i][j + 3] > Jump_threhold && (imgbuff[i][j] - imgbuff[i][j+4] > Jump_threhold))) //   ！！！！！改  ？&&imgbuff[i][j]>150&&imgbuff[i][j-3]<150
          {
            zhangai_line_you[i] = j + 3;
            zhangaifind_flag = 1;
            zhangai_break = i;
            break;
          }
          else
          {
            zhangaifind_flag=0;            
          }
        }
        if (zhangaifind_flag==0)
        {
          break;
        }
      }
      if(zhangai_start-zhangai_break>=4)
      {
        zhangaifind_you_flag = 1;
      }
    }
    
    if (zhangai_left_flag==1)
    { 
      for (int i = zhangai_start - 3; i >= zhangai_start - 12; i--)           //10??????????????   1  
      {
        for (int j = zhangai_line_zuo[i + 1] + 10; j >= zhangai_line_zuo[i + 1] - 10; j--)
        {
          if((imgbuff[i][j]-imgbuff[i][j-3]>Jump_threhold) && (imgbuff[i][j]-imgbuff[i][j-4]>Jump_threhold))        // ((imgbuff[i][j] - imgbuff[i][j - 2] > 30))
          {
            zhangai_line_zuo[i] = j - 3;
            zhangaifind_flag = 1;
            zhangai_break = i;
            break;
          }
          else
          {
            zhangaifind_flag=0;
          }
        }
        if(zhangaifind_flag==0)
        {  
          break;
        }
      }
      if(zhangai_start-zhangai_break>=4)
      {
        zhangaifind_zuo_flag = 1;
      }
    }
  } 
}

/****************************************************
十字超车判断
***************************************************/
void shizi_chaoche_check(void)
{
  //  chaoche_right_flag = 0;
  chaoche_left_flag = 0;
  //  chaoche_start = 0;
  //  chaoche_start_you=0;  
  chaoche_start_zuo=0; 
  chaochefind_flag=0;
  chaoche_start=0;
  count=0;
  chaoche_break=0;
  for (int i = 39; i >= 0; i--)
  {
    chaoche_line_zuo[i] = 0;
    chaoche_line_you[i] = 0;
  }
  
  for (int i = shizi_star; i >= break_right_shizi; i--)//15
  {
    for (j = rightline[i]; j >= rightline[i]-width[i]/1.5; j--)     
    {
      if ((imgbuff[i][j] - imgbuff[i][j-4] > Jump_threhold) && (imgbuff[i][j]-imgbuff[i][j-3]>Jump_threhold )&&imgbuff[i][j]>150&&imgbuff[i][j-3]<150)
      {
        count++;
        chaoche_line_zuo[i] = j - 3;
        break;
      }
    }
    if(count==3)
    {
      count=0;
      chaoche_start_zuo = i+2;
      break;
    }
  }
  //  if(chaoche_start_zuo==0&&chaoche_start_you!=0)
  //  {
  //    chaoche_start=chaoche_start_you;
  //    chaoche_right_flag = 1;
  //  }
  if(chaoche_start_zuo!=0)    //&&chaoche_start_you==0
  {
    chaoche_start=chaoche_start_zuo;
    chaoche_left_flag = 1;
  }  
  
  if (chaoche_start!= 0)
  {
    if (chaoche_left_flag==1)
    { 
      for (int i = chaoche_start - 3; i >= chaoche_start - 12; i--)           //10??????????????   12  for (j = rightline[i]; j <= rightline[i]-width[i]; j--)    
      {
        for (j = rightline[i]; j >= rightline[i]-width[i]/1.5; j--)
        {
          if((imgbuff[i][j]-imgbuff[i][j-3]>Jump_threhold) && (imgbuff[i][j]-imgbuff[i][j-4]>Jump_threhold))        // ((imgbuff[i][j] - imgbuff[i][j - 2] > 30))
          {
            chaoche_line_zuo[i] = j - 3;
            chaochefind_flag = 1;
            chaoche_break = i;
            break;
          }
          else
          {
            chaochefind_flag=0;
          }
        }
        if(chaochefind_flag==0)
        {  
          break;
        }
      }
      if(chaoche_start-chaoche_break>=4)
      {
        chaochefind_zuo_flag = 1;
      }
    }
  }
}

/****************************************************
直道超车判断
***************************************************/
void chaoche_check(void)
{
  //  chaoche_right_flag = 0;
  chaoche_left_flag = 0;
  //  chaoche_start = 0;
  //  chaoche_start_you=0;  
  chaoche_start_zuo=0; 
  chaochefind_flag=0;
  chaoche_start=0;
  count=0;
  chaoche_break=0;
  for (int i = 39; i >= 0; i--)
  {
    chaoche_line_zuo[i] = 0;
    chaoche_line_you[i] = 0;
  }
  
  for (int i = 39; i >= 15; i--)//15
  {
    for (j = rightline[i]; j >= rightline[i]-width[i]/1.5; j--)     
    {
      if ((imgbuff[i][j] - imgbuff[i][j-4] > Jump_threhold) && (imgbuff[i][j]-imgbuff[i][j-3]>Jump_threhold )&&imgbuff[i][j]>150&&imgbuff[i][j-3]<150)
      {
        count++;
        chaoche_line_zuo[i] = j - 3;
        break;
      }
    }
    if(count==3)
    {
      count=0;
      chaoche_start_zuo = i+2;
      break;
    }
  }
  //  if(chaoche_start_zuo==0&&chaoche_start_you!=0)
  //  {
  //    chaoche_start=chaoche_start_you;
  //    chaoche_right_flag = 1;
  //  }
  if(chaoche_start_zuo!=0)    //&&chaoche_start_you==0
  {
    chaoche_start=chaoche_start_zuo;
    chaoche_left_flag = 1;
  }  
  
  if (chaoche_start!= 0)
  {
    if (chaoche_left_flag==1)
    { 
      for (int i = chaoche_start - 3; i >= chaoche_start - 12; i--)           //10??????????????   12  for (j = rightline[i]; j <= rightline[i]-width[i]; j--)    
      {
        for (j = rightline[i]; j >= rightline[i]-width[i]/1.5; j--)
        {
          if((imgbuff[i][j]-imgbuff[i][j-3]>Jump_threhold) && (imgbuff[i][j]-imgbuff[i][j-4]>Jump_threhold))        // ((imgbuff[i][j] - imgbuff[i][j - 2] > 30))
          {
            chaoche_line_zuo[i] = j - 3;
            chaochefind_flag = 1;
            chaoche_break = i;
            break;
          }
          else
          {
            chaochefind_flag=0;
          }
        }
        if(chaochefind_flag==0)
        {  
          break;
        }
      }
      if(chaoche_start-chaoche_break>=4)
      {
        chaochefind_zuo_flag = 1;
      }
    }
  }
}
//  if(zhangai_start_you==0)
//  {
//    count=0;
//    for (int i = 39; i >= 15; i--)//15
//    {
//      for (j = (leftline[i]+rightline[i])/2; j >= leftline[i]+width[i]/3; j--)     ///往左边扫障碍跳变   5-14改width[i]/3
//      {
//        if ((imgbuff[i][j] - imgbuff[i][j -4] >30) && (imgbuff[i][j] - imgbuff[i][j -3] >30)&&imgbuff[i][j]>150&&imgbuff[i][j-3]<150)
//        {
//          count++;
//          zhangai_line_zuo[i] = j - 3;
//          break;
//        }
//      }
//      if(count==3)
//      {
//        count=0;
//        zhangai_start_zuo = i+2;
//        break;
//      }
//    }
//  }

//  if(chaoche_start_zuo==0&&chaoche_start_you!=0)
//  {
//    chaoche_start=chaoche_start_you;
//    chaoche_right_flag = 1;
//  }
//  else if(chaoche_start_zuo!=0&&chaoche_start_you==0)
//  {
//    chaoche_start=chaoche_start_zuo;
//    chaoche_left_flag = 1;
//  }
//  
//  if (zhangai_start!= 0)
//  {
////    if (zhangai_right_flag==1)
////    { 
////      for(int i = zhangai_start - 3; i >= zhangai_start - 12; i--)        //  ！！！！！！改(int i = zhangai_start - 3; i >= zhangai_start - 13; i--)
////      {
////        for (int j = zhangai_line_you[i + 1] - 10; j <= zhangai_line_you[i + 1] + 10; j++)//int j = zhangai_line_you[i + 1] - 10; j <= zhangai_line_you[i + 1] + 10; j++
////        {       
////          if ((imgbuff[i][j] - imgbuff[i][j + 3] > 30 && (imgbuff[i][j] - imgbuff[i][j+4] > 30))) //   ！！！！！改  ？&&imgbuff[i][j]>150&&imgbuff[i][j-3]<150
////          {
////            zhangai_line_you[i] = j + 3;
////            zhangaifind_flag = 1;
////            zhangai_break = i;
////            break;
////          }
////          else
////          {
////            zhangaifind_flag=0;            
////          }
////        }
////        if (zhangaifind_flag==0)
////        {
////          break;
////        }
////      }
////      if(zhangai_start-zhangai_break>=4)
////      {
////        zhangaifind_you_flag = 1;
////      }
////    }
//    
////    if (chaoche_left_flag==1)
////    { 
////      for (int i = chaoche_start - 3; i >= zhangai_start - 12; i--)           //10??????????????   12  for (j = rightline[i]; j <= rightline[i]-width[i]; j--)    
////      {
////        for (j = rightline[i]; j <= rightline[i]-width[i]; j--)
////        {
////          if((imgbuff[i][j]-imgbuff[i][j-3]>30) && (imgbuff[i][j]-imgbuff[i][j-4]>30))        // ((imgbuff[i][j] - imgbuff[i][j - 2] > 30))
////          {
////            chaoche_line_zuo[i] = j - 3;
////            chaoche_flag = 1;
////            chaoche_break = i;
////            break;
////          }
////          else
////          {
////            zhangaifind_flag=0;
////          }
////        }
////        if(zhangaifind_flag==0)
////        {  
////          break;
////        }
////      }
////      if(zhangai_start-zhangai_break>=4)
////      {
////        zhangaifind_zuo_flag = 1;
////      }
////    }
////  }
//}






//***************差速*************************
void chasu(void)
{  
  if( speed_set==0)
  {
    speed_set_to_left=0;
    speed_set_to_right=0;
  }
  else if (bizhang_zhidao_flag==0&&init_distance<20&&init_distance>-20&&(error_steer[0]>6 || error_steer[0]<-6))   //中线偏差
  {
    speed_set_to_left=speed_set-(int)error_steer[0]*chasu_rate;//0.05
    speed_set_to_right=speed_set+(int)error_steer[0]*chasu_rate;
    
    if (speed_set_to_left<10)
    {
      speed_set_to_left=10;
    }
    
    if (speed_set_to_left>140)
    {
      speed_set_to_left=140;
    }
    
    
    if (speed_set_to_right<10)
    {
      speed_set_to_right=10;
    }
    if (speed_set_to_right>140)
    {
      speed_set_to_right=140;
    }
  }
  else
  {
    speed_set_to_left=speed_set;
    speed_set_to_right=speed_set;
  }
}

//***************NRF*************************
//void nrf_process(void)
//{ 
//
//    buff[0]=11;    //环岛出口准备超车
//   
//    nrf_tx(buff,DATA_PACKET);
//     LCD_Show_Number(3,3,buff[0]);
//    while(nrf_tx_state() == NRF_TXING);              //等待发送完成 6 7 if( NRF_TX_OK == nrf_tx_state () )
//    if(NRF_TX_OK == nrf_tx_state ())
//    {
//      LCD_Show_Number(3,5,buff[0]);
//      //   send_count++;
//      send_show_number=send_num;
//      buff[0]=0;
//      send_num=0;
//    }    
//    buff[0]=0;   
//
//  relen=nrf_rx(buff,DATA_PACKET);
//  //  {            
//  //    relen = nrf_rx(buff,8);               //等待接收一个数据包，数据存储在buff里
//  if(relen != 0)
//  {
//    LCD_Show_Number(2,2,buff[0]);//LCD_P8x LCD_Show_Number(1,1,0);//16Str(2,2,buff);// printf("\n接收到数据:%s",buff);    // LCD_P8x16Str(3,3,buff); //printf("\n接收到数据:%s",buff);             //打印接收到的数据
//  }
//}



void nrf_process(void)
{ 
  if(send_num!=0)
  {
    //sprintf((char*)buff,"%s%c",str,send_num);
    if(send_num==1)
    {
      buff[0]=11;     //环岛出口准备超车
    }
    else if(send_num==2)
    {
      buff[0]=22;      //直道准备超车
    }
    else if(send_num==3)
    {
      buff[0]=33;      //防止后车在十字识别环岛
    }
    else if(send_num==5)
    {
      buff[0]=55;      //后车起跑超车完毕
    }
    else if(send_num==6)
    {
      buff[0]=66;      //发送终点加速信号
    }
    else if(send_num==7)
    {
      buff[0]=77;      //发给后车信号
    }
    else if(send_num==8)
    {
      buff[0]=88;      //坡道
    }
    else if(send_num==9)
    {
      buff[0]=99;      //前车入环，后车准备
    }
    nrf_tx(buff,8);
    LCD_Show_Number(20,5, buff[0]);
    while(nrf_tx_state() == NRF_TXING);              //等待发送完成 6 7 if( NRF_TX_OK == nrf_tx_state () )
    if(NRF_TX_OK == nrf_tx_state ())
    {
      //   send_count++;
      send_show_number=send_num;
      buff[0]=0;
      send_num=0;
      LCD_Show_Number(80,5,send_show_number);
    }   
    buff[0]=0;   
  }
  relen=nrf_rx(buff,8);
  //  {            
  //    relen = nrf_rx(buff,8);               //等待接收一个数据包，数据存储在buff里
  if(relen != 0)
  {  
    LCD_Show_Number(50,7,buff[0]);//LCD_P8x LCD_Show_Number(1,1,0);//16Str(2,2,buff);// printf("\n接收到数据:%s",buff);    // LCD_P8x16Str(3,3,buff); //printf("\n接收到数据:%s",buff);             //打印接收到的数据
    if(buff[0]==11)       //环岛出口准备超车
    {
      buff[0]=0;
      former_flag=1;
    }
    else if(buff[0]==22)      //直道准备超车
    {
      buff[0]=0;
      jieshouchaoche_flag=1; 
    }
    else if(buff[0]==33)       //防止后车在十字识别环岛
    {
      buff[0]=0;
      qian_shizi_flag=1; 
    }
    else if(buff[0]==44)     //前车发车停车
    {
      buff[0]=0;
      fache_state=1;
    }
    else if(buff[0]==66)
    {
      buff[0]=0;
      zhongdianjiasu_flag=1; 
    } 
    else if(buff[0]==77)
    {
      buff[0]=0;
      stop_flag=1; 
    } 
    else if(buff[0]==88)
    {
      buff[0]=0;
      podao_ready_flag=1; 
    }
    else if(buff[0]==99)
    {
      buff[0]=0;
      ruhuandao_ready=1; 
    }
    
    //    else if(buff[0]==55)     //后车发车超车结束
    //    {
    //      buff[0]=0;
    //      fache_flag=3;       
    //      former_flag=1;
    //    }
  }
  
  
  
  
  
  //  if(relen!=0)
  //  {
  //    if(buff[0]-48==18)                       ///////右边障碍
  //    {
  //      buff[0]=0;
  //      jieshou_zhangai_flag=2;     
  //      distance_read_for_obstacle=Distance_ce;
  //      receive_show_number=18;               //读取前车发现障碍时的距离
  //    } 
  //    else if (buff[0]-48==19)               ///////左边障碍
  //    {    
  //      buff[0]=0;
  //      //   receive_count++;
  //      jieshou_zhangai_flag=1;               
  //      distance_read_for_obstacle=Distance_ce;
  //      receive_show_number=19;           //读取前车发现障碍时的距离 
  //    }
  //    else if(buff[0]-48==20)               //////右边超车区
  //    {
  //      buff[0]=0;
  //      jieshouchaoche_flag=1;
  //      receive_show_number=20;
  //    }
  //    else if(buff[0]-48==21)              ////////左边超车区
  //    {
  //      buff[0]=0;
  //      jieshouchaoche_flag=2;
  //      receive_show_number=21;
  //    }
  //    else  if((buff[0]-48)==22)         //////////
  //    {    
  //      buff[0]=0;
  //      jieshou_start_flag=1;
  //      receive_show_number=22;
  //    }
  //    else if(buff[0]-48==23)            ///////////左转三角
  //    {
  //      buff[0]=0;
  //      jieshou_sanjiao_flag=1;
  //      receive_show_number=23;  
  //    }
  //    else if(buff[0]-48==24)          /////////////右转三角
  //    {
  //      buff[0]=0;
  //      jieshou_sanjiao_flag=2;
  //      receive_show_number=24;
  //      
  //    }
  //    else if((buff[0]-48)==25)      
  //    {
  //      buff[0]=0;
  //      receive_show_number=25;
  //      if(pre_starting_count==0)
  //      {
  //        rush_flag=1;
  //        pre_starting_count=starting_count;
  //      }
  //    }
  //  } 
}
void LP_image()
{
  uint8 *a_point, *b_point, *c_point;
  uint8 a, b, c, d, i, j;
  
  for (i = 0; i < CAMERA_R_H; i++)
  {
    for (j = 1; j < (CAMERA_W - 1); j++)
    {
      a_point = &imgbuff[i][j - 1];
      b_point = &imgbuff[i][j];
      c_point = &imgbuff[i][j + 1];
      
      a = *a_point;
      b = *b_point;
      c = *c_point;
      
      if (a >= b)
      {
        d = b;
        b = a;
        a = d;
      }
      if (a >= c)
      {
        d = c;
        c = a;
        a = d;
      }
      if (b >= c)
      {
        d = c;
        c = b;
        b = d;
      }
      *(b_point) = b;
    }
  }
}

/*!
*  @brief      PORTB中断服务函数
*  @since      v5.0
*/
void portb_handler()
{
  uint8 n;                   //引脚号
  n = 7;                     //行中断
  if (PORTB_ISFR & (1 << n)) // PTB7触发中断
  {
    PORTB_ISFR = (1 << n); //写1清中断标志位
    HS++;
    V_Cnt++;
    if (V_Cnt <= CAMERA_H)
    {
      if (V_Cnt == sz[num])
      {
        systick_delay(460); // 460
        DMA_EN(DMA_CH0);
        num++;
      }
    }
    else
    {
      disable_irq(PORTB_IRQn);
      img_flag = 3;
    }
  }
}

void portc_handler()
{
  uint8 n;                   //引脚号
  n = 3;                     //场中断
  if (PORTC_ISFR & (1 << n)) // PTC3触发中断
  {
    PORTC_ISFR = (1 << n); //写1清中断标志位
    VS++;
    img_flag = 2;
    DMA_DADDR(DMA_CH0) = (uint32)imgbuff; //恢复地址
    V_Cnt = 0;
    num = 0;
    enable_irq(PORTB_IRQn);
    disable_irq(PORTC_IRQn);
  }
}
